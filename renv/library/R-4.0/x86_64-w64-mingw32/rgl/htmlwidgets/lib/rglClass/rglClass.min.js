rglwidgetClass=function(){this.canvas=null,this.userMatrix=new CanvasMatrix4,this.types=[],this.prMatrix=new CanvasMatrix4,this.mvMatrix=new CanvasMatrix4,this.vp=null,this.prmvMatrix=null,this.origs=null,this.gl=null,this.scene=null,this.select={state:"inactive",subscene:null,region:{p1:{x:0,y:0},p2:{x:0,y:0}}},this.drawing=!1},rglwidgetClass.prototype.f_is_lit=1,rglwidgetClass.prototype.f_is_smooth=2,rglwidgetClass.prototype.f_has_texture=4,rglwidgetClass.prototype.f_depth_sort=8,rglwidgetClass.prototype.f_fixed_quads=16,rglwidgetClass.prototype.f_is_transparent=32,rglwidgetClass.prototype.f_is_lines=64,rglwidgetClass.prototype.f_sprites_3d=128,rglwidgetClass.prototype.f_is_subscene=256,rglwidgetClass.prototype.f_is_clipplanes=512,rglwidgetClass.prototype.f_fixed_size=1024,rglwidgetClass.prototype.f_is_points=2048,rglwidgetClass.prototype.f_is_twosided=4096,rglwidgetClass.prototype.f_fat_lines=8192,rglwidgetClass.prototype.f_is_brush=16384,rglwidgetClass.prototype.f_has_fog=32768,rglwidgetClass.prototype.fogNone=0,rglwidgetClass.prototype.fogLinear=1,rglwidgetClass.prototype.fogExp=2,rglwidgetClass.prototype.fogExp2=3,rglwidgetClass.prototype.start=function(){"undefined"!=typeof this.prefix&&(this.debugelement=document.getElementById(this.prefix+"debug"),this.debug("")),this.drag=0,this.drawScene()},rglwidgetClass.prototype.multMV=function(M,v){return[M.m11*v[0]+M.m12*v[1]+M.m13*v[2]+M.m14*v[3],M.m21*v[0]+M.m22*v[1]+M.m23*v[2]+M.m24*v[3],M.m31*v[0]+M.m32*v[1]+M.m33*v[2]+M.m34*v[3],M.m41*v[0]+M.m42*v[1]+M.m43*v[2]+M.m44*v[3]]},rglwidgetClass.prototype.multVM=function(v,M){return[M.m11*v[0]+M.m21*v[1]+M.m31*v[2]+M.m41*v[3],M.m12*v[0]+M.m22*v[1]+M.m32*v[2]+M.m42*v[3],M.m13*v[0]+M.m23*v[1]+M.m33*v[2]+M.m43*v[3],M.m14*v[0]+M.m24*v[1]+M.m34*v[2]+M.m44*v[3]]},rglwidgetClass.prototype.vlen=function(v){return Math.sqrt(this.dotprod(v,v))},rglwidgetClass.prototype.dotprod=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},rglwidgetClass.prototype.xprod=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},rglwidgetClass.prototype.cbind=function(a,b){return b.length<a.length?b=this.repeatToLen(b,a.length):a.length<b.length&&(a=this.repeatToLen(a,b.length)),a.map(function(currentValue,index){return currentValue.concat(b[index])})},rglwidgetClass.prototype.swap=function(a,i,j){var temp=a[i];a[i]=a[j],a[j]=temp},rglwidgetClass.prototype.flatten=function(arr,result){var value;"undefined"==typeof result&&(result=[]);for(var i=0,length=arr.length;length>i;i++)value=arr[i],Array.isArray(value)?this.flatten(value,result):result.push(value);return result},rglwidgetClass.prototype.setElement=function(a,i,value){if(Array.isArray(a[0])){var dim=a.length,col=Math.floor(i/dim),row=i%dim;a[row][col]=value}else a[i]=value},rglwidgetClass.prototype.transpose=function(a){var i,newArray=[],n=a.length,m=a[0].length;for(i=0;m>i;i++)newArray.push([]);for(i=0;n>i;i++)for(var j=0;m>j;j++)newArray[j].push(a[i][j]);return newArray},rglwidgetClass.prototype.sumsq=function(x){var i,result=0;for(i=0;i<x.length;i++)result+=x[i]*x[i];return result},rglwidgetClass.prototype.toCanvasMatrix4=function(mat){if(mat instanceof CanvasMatrix4)return mat;var result=new CanvasMatrix4;return mat=this.flatten(this.transpose(mat)),result.load(mat),result},rglwidgetClass.prototype.stringToRgb=function(s){s=s.replace("#","");var bigint=parseInt(s,16);return[(bigint>>16&255)/255,(bigint>>8&255)/255,(255&bigint)/255]},rglwidgetClass.prototype.whichList=function(id){var obj=this.getObj(id),flags=obj.flags;return"light"===obj.type?"lights":this.isSet(flags,this.f_is_subscene)?"subscenes":this.isSet(flags,this.f_is_clipplanes)?"clipplanes":this.isSet(flags,this.f_is_transparent)?"transparent":"opaque"},rglwidgetClass.prototype.componentProduct=function(x,y){"undefined"==typeof y&&this.alertOnce("Bad arg to componentProduct");var i,result=new Float32Array(3);for(i=0;3>i;i++)result[i]=x[i]*y[i];return result},rglwidgetClass.prototype.getPowerOfTwo=function(value){for(var pow=1;value>pow;)pow*=2;return pow},rglwidgetClass.prototype.unique=function(arr){return arr=[].concat(arr),arr.filter(function(value,index,self){return self.indexOf(value)===index})},rglwidgetClass.prototype.equalArrays=function(a,b){return a===b||a&&b&&a.length===b.length&&a.every(function(v,i){return v===b[i]})},rglwidgetClass.prototype.repeatToLen=function(arr,len){for(arr=[].concat(arr);arr.length<len/2;)arr=arr.concat(arr);return arr.concat(arr.slice(0,len-arr.length))},rglwidgetClass.prototype.alertOnce=function(msg){"undefined"==typeof this.alerted&&(this.alerted=!0,alert(msg))},rglwidgetClass.prototype.getObj=function(id){return"number"!=typeof id&&this.alertOnce("getObj id is "+typeof id),this.scene.objects[id]},rglwidgetClass.prototype.getIdsByType=function(type,subscene){var i,ids,result=[],self=this;if("undefined"==typeof subscene)Object.keys(this.scene.objects).forEach(function(key){key=parseInt(key,10),self.getObj(key).type===type&&result.push(key)});else for(ids=this.getObj(subscene).objects,i=0;i<ids.length;i++)this.getObj(ids[i]).type===type&&result.push(ids[i]);return result},rglwidgetClass.prototype.getObjMaterial=function(obj,property){var mat;return"undefined"==typeof obj.material&&console.error("material undefined"),mat=obj.material[property],"undefined"==typeof mat&&(mat=this.scene.material[property]),mat},rglwidgetClass.prototype.getMaterial=function(id,property){var obj=this.getObj(id);return this.getObjMaterial(obj,property)},rglwidgetClass.prototype.getAdj=function(pos,offset,text){switch(pos){case 1:return[.5,1+offset];case 2:return[1+offset/text.length,.5];case 3:return[.5,-offset];case 4:return[-offset/text.length,.5]}},rglwidgetClass.prototype.countClipplanes=function(){return this.countObjs("clipplanes")},rglwidgetClass.prototype.countLights=function(){return this.countObjs("light")},rglwidgetClass.prototype.countObjs=function(type){var self=this,bound=0;return Object.keys(this.scene.objects).forEach(function(key){self.getObj(parseInt(key,10)).type===type&&(bound+=1)}),bound},rglwidgetClass.prototype.debug=function(msg,img){"undefined"!=typeof this.debugelement&&null!==this.debugelement?(this.debugelement.innerHTML=msg,"undefined"!=typeof img&&this.debugelement.insertBefore(img,this.debugelement.firstChild)):""!==msg&&alert(msg)},rglwidgetClass.prototype.getSlide=function(){for(var result=this.el,done=!1;result&&!done&&this.scene.context.rmarkdown;){switch(this.scene.context.rmarkdown){case"ioslides_presentation":if("SLIDE"===result.tagName)return result;break;case"slidy_presentation":if("DIV"===result.tagName&&result.classList.contains("slide"))return result;break;default:return null}result=result.parentElement}return null},rglwidgetClass.prototype.isInBrowserViewport=function(){var rect=this.canvas.getBoundingClientRect(),windHeight=window.innerHeight||document.documentElement.clientHeight,windWidth=window.innerWidth||document.documentElement.clientWidth;return this.scene.context&&null!==this.scene.context.rmarkdown&&this.slide?"ioslides_presentation"===this.scene.context.rmarkdown&&this.slide.classList.contains("current")||"slidy_presentation"===this.scene.context.rmarkdown&&!this.slide.classList.contains("hidden"):rect.top>=-windHeight&&rect.left>=-windWidth&&rect.bottom<=2*windHeight&&rect.right<=2*windWidth},rglwidgetClass.prototype.keydiff=function(obj1,obj2){var i,keys=Object.keys(obj1),result=[];for(i=0;i<keys.length;i++)"undefined"!=typeof obj1[keys[i]]&&"undefined"==typeof obj2[keys[i]]&&result.push(keys[i]);return result},rglwidgetClass.prototype.isSet=function(flags,flag){return 0!==(flags&flag)},rglwidgetClass.prototype.inSubscene=function(id,subscene){return this.getObj(subscene).objects.indexOf(id)>-1},rglwidgetClass.prototype.translateCoords=function(subsceneid,coords){var viewport=this.getObj(subsceneid).par3d.viewport;return{x:coords.x-viewport.x*this.canvas.width,y:coords.y-viewport.y*this.canvas.height}},rglwidgetClass.prototype.inViewport=function(coords,subsceneid){var viewport=this.getObj(subsceneid).par3d.viewport,x0=coords.x-viewport.x*this.canvas.width,y0=coords.y-viewport.y*this.canvas.height;return x0>=0&&x0<=viewport.width*this.canvas.width&&y0>=0&&y0<=viewport.height*this.canvas.height},rglwidgetClass.prototype.whichSubscene=function(coords){var self=this,recurse=function(subsceneid){var i,id,subscenes=self.getChildSubscenes(subsceneid);for(i=0;i<subscenes.length;i++)if(id=recurse(subscenes[i]),"undefined"!=typeof id)return id;return self.inViewport(coords,subsceneid)?subsceneid:void 0},rootid=this.scene.rootSubscene,result=recurse(rootid);return"undefined"==typeof result&&(result=rootid),result},rglwidgetClass.prototype.addToSubscene=function(id,subscene){var thelist,i,thesub=this.getObj(subscene),ids=[id],obj=this.getObj(id);for("undefined"!=typeof obj&&"undefined"!=typeof obj.newIds&&(ids=ids.concat(obj.newIds)),thesub.objects=[].concat(thesub.objects),i=0;i<ids.length;i++)id=ids[i],-1===thesub.objects.indexOf(id)&&(thelist=this.whichList(id),thesub.objects.push(id),thesub[thelist].push(id))},rglwidgetClass.prototype.delFromSubscene=function(id,subscene){var thelist,i,j,thesub=this.getObj(subscene),obj=this.getObj(id),ids=[id];for("undefined"!=typeof obj&&"undefined"!=typeof obj.newIds&&(ids=ids.concat(obj.newIds)),thesub.objects=[].concat(thesub.objects),j=0;j<ids.length;j++)id=ids[j],i=thesub.objects.indexOf(id),i>-1&&(thesub.objects.splice(i,1),thelist=this.whichList(id),i=thesub[thelist].indexOf(id),thesub[thelist].splice(i,1))},rglwidgetClass.prototype.setSubsceneEntries=function(ids,subsceneid){var sub=this.getObj(subsceneid);sub.objects=ids,this.initSubscene(subsceneid)},rglwidgetClass.prototype.getSubsceneEntries=function(subscene){return this.getObj(subscene).objects},rglwidgetClass.prototype.getChildSubscenes=function(subscene){return this.getObj(subscene).subscenes},rglwidgetClass.prototype.useid=function(subsceneid,type){var sub=this.getObj(subsceneid);return"inherit"===sub.embeddings[type]?this.useid(sub.parent,type):subsceneid},rglwidgetClass.prototype.getVertexShader=function(id){var result,obj=this.getObj(id),userShader=obj.userVertexShader,flags=obj.flags,type=obj.type,is_lit=this.isSet(flags,this.f_is_lit),has_texture=this.isSet(flags,this.f_has_texture),fixed_quads=this.isSet(flags,this.f_fixed_quads),sprites_3d=this.isSet(flags,this.f_sprites_3d),nclipplanes=this.countClipplanes(),fixed_size=this.isSet(flags,this.f_fixed_size),is_points=this.isSet(flags,this.f_is_points),is_twosided=this.isSet(flags,this.f_is_twosided),fat_lines=this.isSet(flags,this.f_fat_lines),is_brush=this.isSet(flags,this.f_is_brush),has_fog=this.isSet(flags,this.f_has_fog),has_normals="undefined"!=typeof obj.normals,needs_vnormal=is_lit&&!fixed_quads&&!is_brush||is_twosided&&(has_normals||"spheres"===obj.type);if("clipplanes"!==type&&!sprites_3d){if("undefined"!=typeof userShader)return userShader;if(result="  /* ****** "+type+" object "+id+" vertex shader ****** */\n#ifdef GL_ES\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n#endif\n  attribute vec3 aPos;\n  attribute vec4 aCol;\n  uniform mat4 mvMatrix;\n  uniform mat4 prMatrix;\n  varying vec4 vCol;\n  varying vec4 vPosition;\n",needs_vnormal&&(result+="  attribute vec3 aNorm;\n  uniform mat4 normMatrix;\n  varying vec3 vNormal;\n"),(has_texture||"text"===type)&&(result+="  attribute vec2 aTexcoord;\n  varying vec2 vTexcoord;\n"),fixed_size&&(result+="  uniform vec2 textScale;\n"),fixed_quads&&(result+="  attribute vec2 aOfs;\n"),is_twosided&&(result+=has_normals||"spheres"===obj.type?"  varying float normz;\n":"  attribute vec3 aPos1;\n  attribute vec3 aPos2;\n  varying float normz;\n"),fat_lines&&(result+="  attribute vec3 aNext;\n  attribute vec2 aPoint;\n  varying vec2 vPoint;\n  varying float vLength;\n  uniform float uAspect;\n  uniform float uLwd;\n"),result+="  void main(void) {\n",!nclipplanes&&fixed_quads&&!has_fog||is_brush||(result+="    vPosition = mvMatrix * vec4(aPos, 1.);\n"),fixed_quads||is_brush||(result+="    gl_Position = prMatrix * vPosition;\n"),is_points){var size=this.getMaterial(id,"size");result=result+"    gl_PointSize = "+size.toFixed(1)+";\n"}return result+="    vCol = aCol;\n",needs_vnormal&&(result+="    vNormal = normalize((normMatrix * vec4(aNorm, 1.)).xyz);\n"),(has_texture||"text"===type)&&(result+="    vTexcoord = aTexcoord;\n"),fixed_size&&(result+="    vec4 pos = prMatrix * mvMatrix * vec4(aPos, 1.);\n   pos = pos/pos.w;\n   gl_Position = pos + vec4(aOfs*textScale, 0.,0.);\n"),"sprites"!==type||fixed_size||(result+="    vec4 pos = mvMatrix * vec4(aPos, 1.);\n   pos = pos/pos.w + vec4(aOfs, 0., 0.);\n   gl_Position = prMatrix*pos;\n"),is_twosided&&(result+=has_normals||"spheres"===obj.type?"   normz = vNormal.z;":"   vec4 pos1 = prMatrix*(mvMatrix*vec4(aPos1, 1.));\n   pos1 = pos1/pos1.w - gl_Position/gl_Position.w;\n   vec4 pos2 = prMatrix*(mvMatrix*vec4(aPos2, 1.));\n   pos2 = pos2/pos2.w - gl_Position/gl_Position.w;\n   normz = pos1.x*pos2.y - pos1.y*pos2.x;\n"),fat_lines&&(result+="   vec2 aspectVec = vec2(uAspect, 1.0);\n   mat4 projViewModel = prMatrix * mvMatrix;\n   vec4 currentProjected = projViewModel * vec4(aPos, 1.0);\n   currentProjected = currentProjected/currentProjected.w;\n   vec4 nextProjected = projViewModel * vec4(aNext, 1.0);\n   vec2 currentScreen = currentProjected.xy * aspectVec;\n   vec2 nextScreen = (nextProjected.xy / nextProjected.w) * aspectVec;\n   float len = uLwd;\n   vec2 dir = vec2(1.0, 0.0);\n   vPoint = aPoint;\n   vLength = length(nextScreen - currentScreen)/2.0;\n   vLength = vLength/(vLength + len);\n   if (vLength > 0.0) {\n     dir = normalize(nextScreen - currentScreen);\n   }\n   vec2 normal = vec2(-dir.y, dir.x);\n   dir.x /= uAspect;\n   normal.x /= uAspect;\n   vec4 offset = vec4(len*(normal*aPoint.x*aPoint.y - dir), 0.0, 0.0);\n   gl_Position = currentProjected + offset;\n"),is_brush&&(result+="   gl_Position = vec4(aPos, 1.);\n"),result+="  }\n"}},rglwidgetClass.prototype.getFragmentShader=function(id){var i,texture_format,nlights,result,obj=this.getObj(id),userShader=obj.userFragmentShader,flags=obj.flags,type=obj.type,is_lit=this.isSet(flags,this.f_is_lit),has_texture=this.isSet(flags,this.f_has_texture),fixed_quads=this.isSet(flags,this.f_fixed_quads),sprites_3d=this.isSet(flags,this.f_sprites_3d),is_twosided=this.isSet(flags,this.f_is_twosided),fat_lines=this.isSet(flags,this.f_fat_lines),is_transparent=this.isSet(flags,this.f_is_transparent),is_points=this.isSet(flags,this.f_is_points),has_fog=this.isSet(flags,this.f_has_fog),nclipplanes=this.countClipplanes();if("clipplanes"!==type&&!sprites_3d){if("undefined"!=typeof userShader)return userShader;for(has_texture&&(texture_format=this.getMaterial(id,"textype")),result="/* ****** "+type+" object "+id+" fragment shader ****** */\n#ifdef GL_ES\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n#endif\n  varying vec4 vCol; // carries alpha\n  varying vec4 vPosition;\n",(has_texture||"text"===type)&&(result+="  varying vec2 vTexcoord;\n  uniform sampler2D uSampler;\n"),has_fog&&(result+="  uniform int uFogMode;\n  uniform vec3 uFogColor;\n  uniform vec4 uFogParms;\n"),is_lit&&!fixed_quads&&(result+="  varying vec3 vNormal;\n"),i=0;nclipplanes>i;i++)result=result+"  uniform vec4 vClipplane"+i+";\n";if(is_lit&&(nlights=this.countLights(),nlights?result+="  uniform mat4 mvMatrix;\n":is_lit=!1),is_lit)for(result+="  uniform vec3 emission;\n  uniform float shininess;\n",i=0;nlights>i;i++)result=result+"  uniform vec3 ambient"+i+";\n  uniform vec3 specular"+i+"; // light*material\n  uniform vec3 diffuse"+i+";\n  uniform vec3 lightDir"+i+";\n  uniform bool viewpoint"+i+";\n  uniform bool finite"+i+";\n";if(is_twosided&&(result+="  uniform bool front;\n  varying float normz;\n"),fat_lines&&(result+="  varying vec2 vPoint;\n  varying float vLength;\n"),result+="  void main(void) {\n    vec4 fragColor;\n",fat_lines&&(result+="    vec2 point = vPoint;\n    bool neg = point.y < 0.0;\n    point.y = neg ?       (point.y + vLength)/(1.0 - vLength) :\n     -(point.y - vLength)/(1.0 - vLength);\n",is_transparent&&"linestrip"===type&&(result+="    if (neg && length(point) <= 1.0) discard;\n"),result+="    point.y = min(point.y, 0.0);\n    if (length(point) > 1.0) discard;\n"),is_points){var round=this.getMaterial(id,"point_antialias");round&&(result+="    vec2 coord = gl_PointCoord - vec2(0.5);\n    if (length(coord) > 0.5) discard;\n")}for(i=0;nclipplanes>i;i++)result=result+"    if (dot(vPosition, vClipplane"+i+") < 0.0) discard;\n";if(fixed_quads?result+="    vec3 n = vec3(0., 0., 1.);\n":is_lit&&(result+="    vec3 n = normalize(vNormal);\n"),is_twosided&&(result+="    if ((normz <= 0.) != front) discard;\n"),is_lit)for(result+="    vec3 eye = normalize(-vPosition.xyz);\n   vec3 lightdir;\n   vec4 colDiff;\n   vec3 halfVec;\n   vec4 lighteffect = vec4(emission, 0.);\n   vec3 col;\n   float nDotL;\n",fixed_quads||(result+="   n = -faceforward(n, n, eye);\n"),i=0;nlights>i;i++)result=result+"   colDiff = vec4(vCol.rgb * diffuse"+i+", vCol.a);\n   lightdir = lightDir"+i+";\n   if (!viewpoint"+i+")\n     lightdir = (mvMatrix * vec4(lightdir, 1.)).xyz;\n   if (!finite"+i+") {\n     halfVec = normalize(lightdir + eye);\n   } else {\n     lightdir = normalize(lightdir - vPosition.xyz);\n     halfVec = normalize(lightdir + eye);\n   }\n    col = ambient"+i+";\n   nDotL = dot(n, lightdir);\n   col = col + max(nDotL, 0.) * colDiff.rgb;\n   col = col + pow(max(dot(halfVec, n), 0.), shininess) * specular"+i+";\n   lighteffect = lighteffect + vec4(col, colDiff.a);\n";else result+="    vec4 colDiff = vCol;\n    vec4 lighteffect = colDiff;\n";return"text"===type&&(result+="    vec4 textureColor = lighteffect*texture2D(uSampler, vTexcoord);\n"),has_texture?result=result+{rgb:"   vec4 textureColor = lighteffect*vec4(texture2D(uSampler, vTexcoord).rgb, 1.);\n",rgba:"   vec4 textureColor = lighteffect*texture2D(uSampler, vTexcoord);\n",alpha:"   vec4 textureColor = texture2D(uSampler, vTexcoord);\n   float luminance = dot(vec3(1.,1.,1.), textureColor.rgb)/3.;\n   textureColor =  vec4(lighteffect.rgb, lighteffect.a*luminance);\n",luminance:"   vec4 textureColor = vec4(lighteffect.rgb*dot(texture2D(uSampler, vTexcoord).rgb, vec3(1.,1.,1.))/3., lighteffect.a);\n","luminance.alpha":"    vec4 textureColor = texture2D(uSampler, vTexcoord);\n    float luminance = dot(vec3(1.,1.,1.),textureColor.rgb)/3.;\n    textureColor = vec4(lighteffect.rgb*luminance, lighteffect.a*textureColor.a);\n"}[texture_format]+"    fragColor = textureColor;\n":result+="text"===type?"    if (textureColor.a < 0.1)\n      discard;\n    else\n      fragColor = textureColor;\n":"    fragColor = lighteffect;\n",result+=has_fog?"    float fogF;\n    if (uFogMode > 0) {\n      fogF = (uFogParms.y - vPosition.z/vPosition.w)/(uFogParms.y - uFogParms.x);\n      if (uFogMode > 1)\n        fogF = mix(uFogParms.w, 1.0, fogF);\n      fogF = fogF*uFogParms.z;\n      if (uFogMode == 2)\n        fogF = 1.0 - exp(-fogF);\n      else if (uFogMode == 3)\n        fogF = 1.0 - exp(-fogF*fogF);\n      fogF = clamp(fogF, 0.0, 1.0);\n      gl_FragColor = vec4(mix(fragColor.rgb, uFogColor, fogF), fragColor.a);\n    } else gl_FragColor = fragColor;\n":"    gl_FragColor = fragColor;\n",result+="  }\n"}},rglwidgetClass.prototype.getShader=function(shaderType,code){var shader,gl=this.gl;return shader=gl.createShader(shaderType),gl.shaderSource(shader,code),gl.compileShader(shader),gl.getShaderParameter(shader,gl.COMPILE_STATUS)||gl.isContextLost()||alert(gl.getShaderInfoLog(shader)),shader},rglwidgetClass.prototype.handleLoadedTexture=function(texture,textureCanvas){var gl=this.gl||this.initGL();gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.bindTexture(gl.TEXTURE_2D,texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,textureCanvas),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null)},rglwidgetClass.prototype.getMaxTexSize=function(){var gl=this.gl||this.initGL();return Math.min(4096,gl.getParameter(gl.MAX_TEXTURE_SIZE))},rglwidgetClass.prototype.loadImageToTexture=function(uri,texture){var canvas=this.textureCanvas,ctx=canvas.getContext("2d"),image=new Image,self=this;image.onload=function(){for(var w=image.width,h=image.height,canvasX=self.getPowerOfTwo(w),canvasY=self.getPowerOfTwo(h),maxTexSize=self.getMaxTexSize();canvasX>1&&canvasY>1&&(canvasX>maxTexSize||canvasY>maxTexSize);)canvasX/=2,canvasY/=2;canvas.width=canvasX,canvas.height=canvasY,ctx.imageSmoothingEnabled=!0,ctx.drawImage(image,0,0,canvasX,canvasY),self.handleLoadedTexture(texture,canvas),self.drawScene()},image.src=uri},rglwidgetClass.prototype.drawTextToCanvas=function(text,cex,family,font){var canvasX,canvasY,i,width,offsetx,line,scaling=20,textColour="white",backgroundColour="rgba(0,0,0,0)",canvas=this.textureCanvas,ctx=canvas.getContext("2d"),textHeight=0,textHeights=[],widths=[],offsety=0,lines=[],offsetsx=[],offsetsy=[],lineoffsetsy=[],fontStrings=[],maxTexSize=this.getMaxTexSize(),getFontString=function(i){textHeights[i]=scaling*cex[i];var fontString=textHeights[i]+"px",family0=family[i],font0=font[i];return"sans"===family0?family0="sans-serif":"mono"===family0&&(family0="monospace"),fontString=fontString+" "+family0,(2===font0||4===font0)&&(fontString="bold "+fontString),(3===font0||4===font0)&&(fontString="italic "+fontString),fontString};for(cex=this.repeatToLen(cex,text.length),family=this.repeatToLen(family,text.length),font=this.repeatToLen(font,text.length),canvasX=1,line=-1,offsetx=maxTexSize,i=0;i<text.length;i++)ctx.font=fontStrings[i]=getFontString(i),width=widths[i]=ctx.measureText(text[i]).width,offsetx+width>maxTexSize&&(offsety+=2*textHeight,line>=0&&(lineoffsetsy[line]=offsety),line+=1,offsety>maxTexSize&&console.error("Too many strings for texture."),textHeight=0,offsetx=0),textHeight=Math.max(textHeight,textHeights[i]),offsetsx[i]=offsetx,offsetx+=width,canvasX=Math.max(canvasX,offsetx),lines[i]=line;for(offsety=lineoffsetsy[line]=offsety+2*textHeight,i=0;i<text.length;i++)offsetsy[i]=lineoffsetsy[lines[i]];for(canvasX=this.getPowerOfTwo(canvasX),canvasY=this.getPowerOfTwo(offsety),canvas.width=canvasX,canvas.height=canvasY,ctx.fillStyle=backgroundColour,ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.textBaseline="alphabetic",i=0;i<text.length;i++)ctx.font=fontStrings[i],ctx.fillStyle=textColour,ctx.textAlign="left",ctx.fillText(text[i],offsetsx[i],offsetsy[i]);return{canvasX:canvasX,canvasY:canvasY,widths:widths,textHeights:textHeights,offsetsx:offsetsx,offsetsy:offsetsy}},rglwidgetClass.prototype.getViewport=function(id){var vp=this.getObj(id).par3d.viewport,x=vp.x*this.canvas.width,y=vp.y*this.canvas.height,width=vp.width*this.canvas.width,height=vp.height*this.canvas.height;this.vp={x:x,y:y,width:width,height:height}},rglwidgetClass.prototype.setViewport=function(id){var gl=this.gl||this.initGL();this.getViewport(id),gl.viewport(this.vp.x,this.vp.y,this.vp.width,this.vp.height),gl.scissor(this.vp.x,this.vp.y,this.vp.width,this.vp.height),gl.enable(gl.SCISSOR_TEST)},rglwidgetClass.prototype.setprMatrix=function(id){var subscene=this.getObj(id),embedding=subscene.embeddings.projection;if("replace"===embedding?this.prMatrix.makeIdentity():this.setprMatrix(subscene.parent),"inherit"!==embedding){var bbox=subscene.par3d.bbox,scale=subscene.par3d.scale,ranges=[(bbox[1]-bbox[0])*scale[0]/2,(bbox[3]-bbox[2])*scale[1]/2,(bbox[5]-bbox[4])*scale[2]/2],radius=1.1*Math.sqrt(this.sumsq(ranges));0>=radius&&(radius=1);var hlen,observer=subscene.par3d.observer,distance=observer[2],FOV=subscene.par3d.FOV,ortho=0===FOV,t=ortho?1:Math.tan(FOV*Math.PI/360),near=distance-radius,far=distance+radius,aspect=this.vp.width/this.vp.height,z=subscene.par3d.zoom,userProjection=subscene.par3d.userProjection;0>far&&(far=1),far/100>near&&(near=far/100),this.frustum={near:near,far:far},hlen=t*near,ortho?aspect>1?this.prMatrix.ortho(-hlen*aspect*z,hlen*aspect*z,-hlen*z,hlen*z,near,far):this.prMatrix.ortho(-hlen*z,hlen*z,-hlen*z/aspect,hlen*z/aspect,near,far):aspect>1?this.prMatrix.frustum(-hlen*aspect*z,hlen*aspect*z,-hlen*z,hlen*z,near,far):this.prMatrix.frustum(-hlen*z,hlen*z,-hlen*z/aspect,hlen*z/aspect,near,far),this.prMatrix.multRight(userProjection)}},rglwidgetClass.prototype.setmvMatrix=function(id){var observer=this.getObj(id).par3d.observer;this.mvMatrix.makeIdentity(),this.setmodelMatrix(id),this.mvMatrix.translate(-observer[0],-observer[1],-observer[2])},rglwidgetClass.prototype.setmodelMatrix=function(id){var subscene=this.getObj(id),embedding=subscene.embeddings.model;if("inherit"!==embedding){var scale=subscene.par3d.scale,bbox=subscene.par3d.bbox,center=[(bbox[0]+bbox[1])/2,(bbox[2]+bbox[3])/2,(bbox[4]+bbox[5])/2];this.mvMatrix.translate(-center[0],-center[1],-center[2]),this.mvMatrix.scale(scale[0],scale[1],scale[2]),this.mvMatrix.multRight(subscene.par3d.userMatrix)}"replace"!==embedding&&this.setmodelMatrix(subscene.parent)},rglwidgetClass.prototype.setnormMatrix=function(subsceneid){var self=this,recurse=function(id){var sub=self.getObj(id),embedding=sub.embeddings.model;if("inherit"!==embedding){var scale=sub.par3d.scale;self.normMatrix.scale(1/scale[0],1/scale[1],1/scale[2]),self.normMatrix.multRight(sub.par3d.userMatrix)}"replace"!==embedding&&recurse(sub.parent)};self.normMatrix.makeIdentity(),recurse(subsceneid)},rglwidgetClass.prototype.setprmvMatrix=function(){this.prmvMatrix=new CanvasMatrix4(this.mvMatrix),this.prmvMatrix.multRight(this.prMatrix)},rglwidgetClass.prototype.getCursor=function(mode){switch(mode){case"none":return"none";case"trackball":case"xAxis":case"yAxis":case"zAxis":case"polar":return"grab";case"selecting":return"crosshair";case"fov":case"zoom":return"zoom-in"}return"dragging"},rglwidgetClass.prototype.setMouseMode=function(mode,button,subscene,stayActive){var sub=this.getObj(subscene),which=["left","right","middle"][button-1];stayActive||"selecting"!==sub.par3d.mouseMode[which]||this.clearBrush(null),sub.par3d.mouseMode[which]=mode,1===button&&(this.canvas.style.cursor=this.getCursor(mode))},rglwidgetClass.prototype.relMouseCoords=function(event){var rect=this.canvas.getBoundingClientRect();return{x:event.clientX-rect.left,y:event.clientY-rect.top}},rglwidgetClass.prototype.recordSelection=function(subid){var result={};"undefined"!=typeof this.select&&"undefined"!=typeof this.select.state&&"inactive"!==this.select.state?(result={subscene:subid,state:this.select.state,region:this.select.region},this.setmvMatrix(subid),result.model=this.mvMatrix,this.setprMatrix(subid),result.proj=this.prMatrix,this.getViewport(subid),result.view=this.vp):result.state="inactive",Shiny.setInputValue(this.scene.selectionInput+":shinyMouse3d",result)},rglwidgetClass.prototype.setMouseHandlers=function(){var activeSubscene,handler,self=this,handlers={},drag=0;handlers.rotBase=0,this.screenToVector=function(x,y){var viewport=this.getObj(activeSubscene).par3d.viewport,width=viewport.width*this.canvas.width,height=viewport.height*this.canvas.height,radius=Math.max(width,height)/2,cx=width/2,cy=height/2,px=(x-cx)/radius,py=(y-cy)/radius,plen=Math.sqrt(px*px+py*py);plen>1e-6&&(px/=plen,py/=plen);var angle=(Math.SQRT2-plen)/Math.SQRT2*Math.PI/2,z=Math.sin(angle),zlen=Math.sqrt(1-z*z);return px*=zlen,py*=zlen,[px,py,z]},handlers.trackballdown=function(x,y){var i,activeSub=this.getObj(activeSubscene),activeModel=this.getObj(this.useid(activeSub.id,"model")),l=activeModel.par3d.listeners;for(handlers.rotBase=this.screenToVector(x,y),this.saveMat=[],i=0;i<l.length;i++)activeSub=this.getObj(l[i]),activeSub.saveMat=new CanvasMatrix4(activeSub.par3d.userMatrix);this.canvas.style.cursor="grabbing"},handlers.trackballmove=function(x,y){var i,rotCurrent=this.screenToVector(x,y),rotBase=handlers.rotBase,dot=rotBase[0]*rotCurrent[0]+rotBase[1]*rotCurrent[1]+rotBase[2]*rotCurrent[2],angle=180*Math.acos(dot/this.vlen(rotBase)/this.vlen(rotCurrent))/Math.PI,axis=this.xprod(rotBase,rotCurrent),objects=this.scene.objects,activeSub=this.getObj(activeSubscene),activeModel=this.getObj(this.useid(activeSub.id,"model")),l=activeModel.par3d.listeners;for(i=0;i<l.length;i++)activeSub=this.getObj(l[i]),activeSub.par3d.userMatrix.load(objects[l[i]].saveMat),activeSub.par3d.userMatrix.rotate(angle,axis[0],axis[1],axis[2]);this.drawScene()},handlers.trackballend=0,this.clamp=function(x,lo,hi){return Math.max(lo,Math.min(x,hi))},this.screenToPolar=function(x,y){var viewport=this.getObj(activeSubscene).par3d.viewport,width=viewport.width*this.canvas.width,height=viewport.height*this.canvas.height,r=Math.min(width,height)/2,dx=this.clamp(x-width/2,-r,r),dy=this.clamp(y-height/2,-r,r);return[Math.asin(dx/r),Math.asin(-dy/r)]},handlers.polardown=function(x,y){var i,activeSub=this.getObj(activeSubscene),activeModel=this.getObj(this.useid(activeSub.id,"model")),l=activeModel.par3d.listeners;for(handlers.dragBase=this.screenToPolar(x,y),this.saveMat=[],i=0;i<l.length;i++)activeSub=this.getObj(l[i]),activeSub.saveMat=new CanvasMatrix4(activeSub.par3d.userMatrix),activeSub.camBase=[-Math.atan2(activeSub.saveMat.m13,activeSub.saveMat.m11),Math.atan2(activeSub.saveMat.m32,activeSub.saveMat.m22)];this.canvas.style.cursor="grabbing"},handlers.polarmove=function(x,y){var i,j,dragCurrent=this.screenToPolar(x,y),activeSub=this.getObj(activeSubscene),activeModel=this.getObj(this.useid(activeSub.id,"model")),objects=this.scene.objects,l=activeModel.par3d.listeners,changepos=[];for(i=0;i<l.length;i++){for(activeSub=this.getObj(l[i]),j=0;2>j;j++)changepos[j]=-(dragCurrent[j]-handlers.dragBase[j]);activeSub.par3d.userMatrix.makeIdentity(),activeSub.par3d.userMatrix.rotate(180*changepos[0]/Math.PI,0,-1,0),activeSub.par3d.userMatrix.multRight(objects[l[i]].saveMat),activeSub.par3d.userMatrix.rotate(180*changepos[1]/Math.PI,-1,0,0)}this.drawScene()},handlers.polarend=0,handlers.axisdown=function(x){handlers.rotBase=this.screenToVector(x,this.canvas.height/2);var i,activeSub=this.getObj(activeSubscene),activeModel=this.getObj(this.useid(activeSub.id,"model")),l=activeModel.par3d.listeners;for(i=0;i<l.length;i++)activeSub=this.getObj(l[i]),activeSub.saveMat=new CanvasMatrix4(activeSub.par3d.userMatrix);this.canvas.style.cursor="grabbing"},handlers.axismove=function(x){var rotCurrent=this.screenToVector(x,this.canvas.height/2),rotBase=handlers.rotBase,angle=180*(rotCurrent[0]-rotBase[0])/Math.PI,rotMat=new CanvasMatrix4;rotMat.rotate(angle,handlers.axis[0],handlers.axis[1],handlers.axis[2]);var i,activeSub=this.getObj(activeSubscene),activeModel=this.getObj(this.useid(activeSub.id,"model")),l=activeModel.par3d.listeners;for(i=0;i<l.length;i++)activeSub=this.getObj(l[i]),activeSub.par3d.userMatrix.load(activeSub.saveMat),activeSub.par3d.userMatrix.multLeft(rotMat);this.drawScene()},handlers.axisend=0,handlers.y0zoom=0,handlers.zoomdown=function(x,y){var i,activeSub=self.getObj(activeSubscene),activeProjection=self.getObj(self.useid(activeSub.id,"projection")),l=activeProjection.par3d.listeners;for(handlers.y0zoom=y,i=0;i<l.length;i++)activeSub=self.getObj(l[i]),activeSub.zoom0=Math.log(activeSub.par3d.zoom);self.canvas.style.cursor="zoom-in"},handlers.zoommove=function(x,y){var i,activeSub=self.getObj(activeSubscene),activeProjection=self.getObj(self.useid(activeSub.id,"projection")),l=activeProjection.par3d.listeners;for(i=0;i<l.length;i++)activeSub=self.getObj(l[i]),activeSub.par3d.zoom=Math.exp(activeSub.zoom0+(y-handlers.y0zoom)/self.canvas.height);self.drawScene()},handlers.zoomend=0,handlers.y0fov=0,handlers.fovdown=function(x,y){handlers.y0fov=y;var i,activeSub=this.getObj(activeSubscene),activeProjection=this.getObj(this.useid(activeSub.id,"projection")),l=activeProjection.par3d.listeners;for(i=0;i<l.length;i++)activeSub=this.getObj(l[i]),activeSub.fov0=activeSub.par3d.FOV;
this.canvas.style.cursor="zoom-in"},handlers.fovmove=function(x,y){var i,activeSub=this.getObj(activeSubscene),activeProjection=this.getObj(this.useid(activeSub.id,"projection")),l=activeProjection.par3d.listeners;for(i=0;i<l.length;i++)activeSub=this.getObj(l[i]),activeSub.par3d.FOV=Math.max(1,Math.min(179,activeSub.fov0+180*(y-handlers.y0fov)/this.canvas.height));this.drawScene()},handlers.fovend=0,handlers.selectingdown=function(x,y){var viewport=this.getObj(activeSubscene).par3d.viewport,width=viewport.width*this.canvas.width,height=viewport.height*this.canvas.height,p={x:2*x/width-1,y:2*y/height-1};this.select.region={p1:p,p2:p},this.select.subscene&&this.select.subscene!==activeSubscene&&this.delFromSubscene(this.scene.brushId,this.select.subscene),this.select.subscene=activeSubscene,this.addToSubscene(this.scene.brushId,activeSubscene),this.select.state="changing","undefined"!=typeof this.scene.brushId&&(this.getObj(this.scene.brushId).initialized=!1),"undefined"!=typeof this.scene.selectionInput&&self.recordSelection(activeSubscene),this.drawScene(),this.canvas.style.cursor="crosshair"},handlers.selectingmove=function(x,y){var viewport=this.getObj(activeSubscene).par3d.viewport,width=viewport.width*this.canvas.width,height=viewport.height*this.canvas.height;"inactive"!==this.select.state&&(this.select.region.p2={x:2*x/width-1,y:2*y/height-1},"undefined"!=typeof this.scene.brushId&&(this.getObj(this.scene.brushId).initialized=!1),"undefined"!=typeof this.scene.selectionInput&&this.recordSelection(activeSubscene),this.drawScene())},handlers.selectingend=0,this.canvas.onmousedown=function(ev){if(!ev.which)switch(ev.button){case 0:ev.which=1;break;case 1:case 4:ev.which=2;break;case 2:ev.which=3}drag=["left","middle","right"][ev.which-1];var coords=self.relMouseCoords(ev);coords.y=self.canvas.height-coords.y,activeSubscene=self.whichSubscene(coords);var f,sub=self.getObj(activeSubscene);switch(handler=sub.par3d.mouseMode[drag]){case"xAxis":handler="axis",handlers.axis=[1,0,0];break;case"yAxis":handler="axis",handlers.axis=[0,1,0];break;case"zAxis":handler="axis",handlers.axis=[0,0,1]}f=handlers[handler+"down"],f?(coords=self.translateCoords(activeSubscene,coords),f.call(self,coords.x,coords.y),ev.preventDefault()):console.warn("Mouse handler '"+handler+"' is not implemented.")},this.canvas.onmouseup=function(ev){if(0!==drag){var f=handlers[handler+"end"];f&&(f.call(self),ev.preventDefault()),drag=0,this.onmousemove(ev)}},this.canvas.onmouseout=this.canvas.onmouseup,this.canvas.onmousemove=function(ev){var sub,f,coords=self.relMouseCoords(ev);coords.y=self.canvas.height-coords.y,0===drag?(activeSubscene=self.whichSubscene(coords),sub=self.getObj(activeSubscene),this.style.cursor=self.getCursor(sub.par3d.mouseMode.left)):(f=handlers[handler+"move"],f&&(coords=self.translateCoords(activeSubscene,coords),f.call(self,coords.x,coords.y)))},handlers.setZoom=function(ds){var i;"undefined"==typeof activeSubscene&&(activeSubscene=self.scene.rootSubscene);var activeSub=self.getObj(activeSubscene),activeProjection=self.getObj(self.useid(activeSub.id,"projection")),l=activeProjection.par3d.listeners;for(i=0;i<l.length;i++)activeSub=self.getObj(l[i]),activeSub.par3d.zoom*=ds;self.drawScene()},handlers.wheelHandler=function(ev){var del=1.02;ev.shiftKey&&(del=1.002);var ds=(ev.detail||ev.wheelDelta)>0?del:1/del;handlers.setZoom(ds),ev.preventDefault()},handlers.get_finger_dist=function(ev){var diffX=ev.touches[0].clientX-ev.touches[1].clientX,diffY=ev.touches[0].clientY-ev.touches[1].clientY;return Math.sqrt(diffX*diffX+diffY*diffY)},handlers.touchstart=function(ev){var touch=ev.touches[0],mouseEvent=new MouseEvent("mousedown",{clientX:touch.clientX,clientY:touch.clientY});if(ev.preventDefault(),2===ev.touches.length){var coords=self.relMouseCoords(touch);coords.y=self.canvas.height-coords.y,activeSubscene=self.whichSubscene(coords),handlers.finger_dist0=handlers.get_finger_dist(ev),handlers.zoomdown(coords.x,coords.y)}this.dispatchEvent(mouseEvent)},handlers.touchend=function(ev){var mouseEvent;ev.preventDefault(),1===ev.touches.length&&(mouseEvent=new MouseEvent("mouseup",{}),this.dispatchEvent(mouseEvent))},handlers.touchmove=function(ev){var mouseEvent,touch=ev.touches[0];if(ev.preventDefault(),ev.touches.length>1){var coords=self.relMouseCoords(touch),new_dist=handlers.get_finger_dist(ev);coords.y=self.canvas.height*Math.log(handlers.finger_dist0/new_dist)+handlers.y0zoom,handlers.zoommove(coords.x,coords.y)}else mouseEvent=new MouseEvent("mousemove",{clientX:touch.clientX,clientY:touch.clientY}),this.dispatchEvent(mouseEvent)},this.canvas.addEventListener("DOMMouseScroll",handlers.wheelHandler,!1),this.canvas.addEventListener("mousewheel",handlers.wheelHandler,!1),this.canvas.addEventListener("touchstart",handlers.touchstart,{passive:!1}),this.canvas.addEventListener("touchend",handlers.touchend,{passive:!1}),this.canvas.addEventListener("touchmove",handlers.touchmove,{passive:!1})},rglwidgetClass.prototype.initGL0=function(){return window.WebGLRenderingContext?void 0:void this.alertOnce("Your browser does not support WebGL. See http://get.webgl.org")},rglwidgetClass.prototype.initGL=function(){var self=this,success=!1;if(this.gl){if(this.drawing||!this.gl.isContextLost())return this.gl;this.restartCanvas()}this.canvas.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.canvas.addEventListener("webglcontextlost",this.onContextLost,!1),this.gl=this.canvas.getContext("webgl",this.webGLoptions)||this.canvas.getContext("experimental-webgl",this.webGLoptions),success=!!(this.gl&&this.gl instanceof WebGLRenderingContext),success||this.alertOnce("Your browser does not support WebGL. See http://get.webgl.org"),this.index_uint=this.gl.getExtension("OES_element_index_uint");var save=this.startDrawing();return Object.keys(this.scene.objects).forEach(function(key){self.initObj(parseInt(key,10))}),this.stopDrawing(save),this.gl},rglwidgetClass.prototype.resize=function(el){this.canvas.width=el.width,this.canvas.height=el.height},rglwidgetClass.prototype.initSphere=function(sections,segments){var i,j,k,ind,mod1,pole,v=[],phi=[],theta=[],it=[],centers=[],result={};for(i=0;sections-1>i;i++)phi.push((i+1)/sections-.5);for(j=0;segments>j;j++)for(theta.push(2*j/segments),i=0;sections-1>i;i++)v.push([Math.sin(Math.PI*theta[j])*Math.cos(Math.PI*phi[i]),Math.sin(Math.PI*phi[i]),Math.cos(Math.PI*theta[j])*Math.cos(Math.PI*phi[i]),theta[j]/2,phi[i]+.5]);for(pole=v.length,v.push([0,-1,0,0,0]),v.push([0,1,0,0,1]),result.values=new Float32Array(this.flatten(v)),result.vertexCount=v.length,mod1=segments*(sections-1),j=0;segments>j;j++){for(i=0;sections-2>i;i++)ind=i+(sections-1)*j,it.push([ind%mod1,(ind+sections-1)%mod1,(ind+sections)%mod1]),it.push([ind%mod1,(ind+sections)%mod1,(ind+1)%mod1]);it.push([pole,(j+1)*(sections-1)%mod1,((j+1)*(sections-1)-sections+1)%mod1]),it.push([pole+1,((j+1)*(sections-1)-1)%mod1,((j+1)*(sections-1)+sections-2)%mod1])}for(result.it=new Uint16Array(this.flatten(it)),i=0;i<it.length;i++)for(centers.push([0,0,0]),j=0;3>j;j++)for(k=0;3>k;k++)centers[i][j]+=v[it[i][k]][j]/3;result.centers=centers,result.vOffsets={vofs:0,cofs:-1,nofs:0,radofs:-1,oofs:-1,tofs:3,nextofs:-1,pointofs:-1,stride:5},result.f=[],result.indices={},result.colorCount=1,result.type="sphere",this.sphere=result,this.initSphereGL()},rglwidgetClass.prototype.initSphereGL=function(){var gl=this.gl||this.initGL(),sphere=this.sphere;gl.isContextLost()||(sphere.buf=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,sphere.buf),gl.bufferData(gl.ARRAY_BUFFER,sphere.values,gl.STATIC_DRAW),sphere.ibuf=[gl.createBuffer(),gl.createBuffer()])},rglwidgetClass.prototype.initSphereFromObj=function(obj){var i,pass,f,mode,sphere=this.sphere;if(sphere.ofsLoc=obj.ofsLoc,sphere.texLoc=obj.texLoc,sphere.sampler=obj.sampler,sphere.uFogMode=obj.uFogMode,sphere.uFogColor=obj.uFogColor,sphere.uFogParms=obj.uFogParms,sphere.userAttribLocations=obj.userAttribLocations,sphere.userUniformLocations=obj.userUniformLocations,sphere.normLoc=obj.normLoc,sphere.clipLoc=obj.clipLoc,sphere.nextLoc=obj.nextLoc,sphere.pointLoc=obj.pointLoc,sphere.aspectLoc=obj.aspectLoc,sphere.lwdLoc=obj.lwdLoc,sphere.prog=obj.prog,sphere.material=obj.material,sphere.flags=obj.flags,sphere.someHidden=obj.someHidden,sphere.fastTransparency=obj.fastTransparency,sphere.nlights=obj.nlights,sphere.emission=obj.emission,sphere.emissionLoc=obj.emissionLoc,sphere.shininess=obj.shininess,sphere.shininessLoc=obj.shininessLoc,sphere.ambient=obj.ambient,sphere.ambientLoc=obj.ambientLoc,sphere.specular=obj.specular,sphere.specularLoc=obj.specularLoc,sphere.diffuse=obj.diffuse,sphere.diffuseLoc=obj.diffuseLoc,sphere.lightDir=obj.lightDir,sphere.lightDirLoc=obj.lightDirLoc,sphere.viewpoint=obj.viewpoint,sphere.viewpointLoc=obj.viewpointLoc,sphere.finite=obj.finite,sphere.finiteLoc=obj.finiteLoc,sphere.prMatLoc=obj.prMatLoc,sphere.mvMatLoc=obj.mvMatLoc,sphere.normMatLoc=obj.normMatLoc,sphere.frontLoc=obj.frontLoc,sphere.index_uint=!1,sphere.is_transparent=obj.is_transparent,sphere.ignoreExtent=obj.ignoreExtent,sphere.passes!==obj.passes||JSON.stringify(sphere.pmode)!==JSON.stringify(obj.pmode))for(sphere.passes=obj.passes,sphere.pmode=obj.pmode,pass=0;pass<obj.passes;pass++){if(mode=sphere.pmode[pass],"undefined"==typeof sphere.indices[mode]){switch(f=[],mode){case"culled":break;case"points":for(f.length=sphere.vertexCount,i=0;i<f.length;i++)f[i]=i;break;case"lines":for(f.length=2*sphere.it.length,i=0;i<sphere.it.length/3;i++)f[6*i]=sphere.it[3*i],f[6*i+1]=sphere.it[3*i+1],f[6*i+2]=sphere.it[3*i+1],f[6*i+3]=sphere.it[3*i+2],f[6*i+4]=sphere.it[3*i+2],f[6*i+5]=sphere.it[3*i];break;case"filled":f=sphere.it}sphere.indices[mode]=new Uint16Array(f)}sphere.f[pass]=sphere.indices[mode]}sphere.initialized=!0},rglwidgetClass.prototype.initSubscene=function(id){var i,obj,sub=this.getObj(id);if("subscene"===sub.type)for(sub.par3d.userMatrix=this.toCanvasMatrix4(sub.par3d.userMatrix),sub.par3d.userProjection=this.toCanvasMatrix4(sub.par3d.userProjection),sub.par3d.userProjection.transpose(),sub.par3d.listeners=[].concat(sub.par3d.listeners),sub.backgroundId=void 0,sub.subscenes=[],sub.clipplanes=[],sub.transparent=[],sub.opaque=[],sub.lights=[],i=0;i<sub.objects.length;i++)obj=this.getObj(sub.objects[i]),"undefined"==typeof obj?(sub.objects.splice(i,1),i--):"background"===obj.type?sub.backgroundId=obj.id:sub[this.whichList(obj.id)].push(obj.id)},rglwidgetClass.prototype.initObj=function(id){var polygon_offset,texinfo,drawtype,nclipplanes,f,nrows,oldrows,i,j,v,v1,v2,mat,uri,matobj,pass,pmode,dim,nx,nz,nrow,obj=this.getObj(id),flags=obj.flags,type=obj.type,is_lit=this.isSet(flags,this.f_is_lit),fat_lines=this.isSet(flags,this.f_fat_lines),has_texture=this.isSet(flags,this.f_has_texture),fixed_quads=this.isSet(flags,this.f_fixed_quads),is_transparent=this.isSet(flags,this.f_is_transparent),depth_sort=this.isSet(flags,this.f_depth_sort),sprites_3d=this.isSet(flags,this.f_sprites_3d),fixed_size=this.isSet(flags,this.f_fixed_size),is_twosided=this.isSet(flags,this.f_is_twosided),is_brush=this.isSet(flags,this.f_is_brush),has_fog=this.isSet(flags,this.f_has_fog),has_normals="undefined"!=typeof obj.normals,gl=this.gl||this.initGL();if("number"!=typeof id&&this.alertOnce("initObj id is "+typeof id),obj.initialized=!0,obj.someHidden=!1,obj.is_transparent=is_transparent,"bboxdeco"!==type&&"subscene"!==type){if("spheres"===type&&"undefined"==typeof this.sphere&&this.initSphere(16,16),"light"===type)return obj.ambient=new Float32Array(obj.colors[0].slice(0,3)),obj.diffuse=new Float32Array(obj.colors[1].slice(0,3)),obj.specular=new Float32Array(obj.colors[2].slice(0,3)),void(obj.lightDir=new Float32Array(obj.vertices[0]));if("clipplanes"===type)return void(obj.vClipplane=this.flatten(this.cbind(obj.normals,obj.offsets)));if("background"===type&&"undefined"!=typeof obj.ids)return void(obj.quad=this.flatten([].concat(obj.ids)));if(polygon_offset=this.getMaterial(id,"polygon_offset"),(0!==polygon_offset[0]||0!==polygon_offset[1])&&(obj.polygon_offset=polygon_offset),is_transparent&&(depth_sort=["triangles","quads","surface","spheres","sprites","text"].indexOf(type)>=0),is_brush&&this.initSelection(id),"undefined"==typeof obj.vertices&&(obj.vertices=[]),v=obj.vertices,obj.vertexCount=v.length,obj.vertexCount){if(is_twosided&&!has_normals){if("undefined"==typeof obj.userAttributes&&(obj.userAttributes={}),v1=Array(v.length),v2=Array(v.length),"triangles"===obj.type||"quads"===obj.type)for(nrow="triangles"===obj.type?3:4,i=0;i<Math.floor(v.length/nrow);i++)for(j=0;nrow>j;j++)v1[nrow*i+j]=v[nrow*i+(j+1)%nrow],v2[nrow*i+j]=v[nrow*i+(j+2)%nrow];else if("surface"===obj.type)for(dim=obj.dim[0],nx=dim[0],nz=dim[1],j=0;nx>j;j++)for(i=0;nz>i;i++)nz>i+1&&nx>j+1?(v2[j+nx*i]=v[j+nx*(i+1)],v1[j+nx*i]=v[j+1+nx*(i+1)]):nz>i+1?(v2[j+nx*i]=v[j-1+nx*i],v1[j+nx*i]=v[j+nx*(i+1)]):(v2[j+nx*i]=v[j+nx*(i-1)],v1[j+nx*i]=v[j-1+nx*(i-1)]);obj.userAttributes.aPos1=v1,obj.userAttributes.aPos2=v2}if(!sprites_3d){if(gl.isContextLost())return;obj.prog=gl.createProgram(),gl.attachShader(obj.prog,this.getShader(gl.VERTEX_SHADER,this.getVertexShader(id))),gl.attachShader(obj.prog,this.getShader(gl.FRAGMENT_SHADER,this.getFragmentShader(id))),gl.bindAttribLocation(obj.prog,0,"aPos"),gl.bindAttribLocation(obj.prog,1,"aCol"),gl.linkProgram(obj.prog);var linked=gl.getProgramParameter(obj.prog,gl.LINK_STATUS);if(!linked){var lastError=gl.getProgramInfoLog(obj.prog);return console.warn("Error in program linking:"+lastError),void gl.deleteProgram(obj.prog)}}"text"===type&&(texinfo=this.drawTextToCanvas(obj.texts,this.flatten(obj.cex),this.flatten(obj.family),this.flatten(obj.family))),fixed_quads&&!sprites_3d&&(obj.ofsLoc=gl.getAttribLocation(obj.prog,"aOfs")),(has_texture||"text"===type)&&(obj.texture||(obj.texture=gl.createTexture()),obj.texLoc=gl.getAttribLocation(obj.prog,"aTexcoord"),obj.sampler=gl.getUniformLocation(obj.prog,"uSampler")),has_fog&&!sprites_3d&&(obj.uFogMode=gl.getUniformLocation(obj.prog,"uFogMode"),obj.uFogColor=gl.getUniformLocation(obj.prog,"uFogColor"),obj.uFogParms=gl.getUniformLocation(obj.prog,"uFogParms")),has_texture&&(mat=obj.material,"undefined"!=typeof mat.uri?uri=mat.uri:"undefined"==typeof mat.uriElementId?(matobj=this.getObj(mat.uriId),uri="undefined"!=typeof matobj?matobj.material.uri:""):uri=document.getElementById(mat.uriElementId).rglinstance.getObj(mat.uriId).material.uri,this.loadImageToTexture(uri,obj.texture)),"text"===type&&this.handleLoadedTexture(obj.texture,this.textureCanvas);var nc,cofs,nofs,radofs,oofs,tofs,vnew,fnew,alias,colors,key,selection,filter,adj,pos,offset,attr,last,options,stride=3,nextofs=-1,pointofs=-1;if(obj.alias=void 0,colors=obj.colors,j=this.scene.crosstalk.id.indexOf(id),j>=0){for(key=this.scene.crosstalk.key[j],options=this.scene.crosstalk.options[j],colors=colors.slice(0),i=0;i<v.length;i++)colors[i]=obj.colors[i%obj.colors.length].slice(0);if((selection=this.scene.crosstalk.selection)&&(selection.length||!options.selectedIgnoreNone))for(i=0;i<v.length;i++)selection.includes(key[i])?options.selectedColor&&(colors[i]=options.selectedColor.slice(0)):(options.deselectedColor&&(colors[i]=options.deselectedColor.slice(0)),colors[i][3]=colors[i][3]*options.deselectedFade);if(filter=this.scene.crosstalk.filter)for(i=0;i<v.length;i++)filter.includes(key[i])||(options.filteredColor&&(colors[i]=options.filteredColor.slice(0)),colors[i][3]=colors[i][3]*options.filteredFade)}for("spheres"===obj.type&&(obj.sphereColors=colors),nc=obj.colorCount=colors.length,nc>1?(cofs=stride,stride+=4,v=this.cbind(v,colors)):(cofs=-1,obj.onecolor=this.flatten(colors)),has_normals?(nofs=stride,stride+=3,v=this.cbind(v,"undefined"!=typeof obj.pnormals?obj.pnormals:obj.normals)):nofs=-1,"undefined"!=typeof obj.radii?(radofs=stride,stride+=1,obj.radii.length===v.length?v=this.cbind(v,obj.radii):1===obj.radii.length&&(v=v.map(function(row){return row.concat(obj.radii[0])}))):radofs=-1,f=Array(v.length),i=0;i<v.length;i++)f[i]=i;if(obj.f=[f,f],"sprites"!==type||sprites_3d)if("text"===type){for(tofs=stride,stride+=2,oofs=stride,stride+=2,vnew=new Array(4*v.length),f=obj.f[0],fnew=new Array(4*f.length),alias=new Array(v.length),last=v.length,adj=this.flatten(obj.adj),"undefined"!=typeof obj.pos&&(pos=this.flatten(obj.pos),offset=adj[0]),i=0;i<v.length;i++)for("undefined"!=typeof pos&&(adj=this.getAdj(pos[i%pos.length],offset,obj.texts[i])),vnew[i]=v[i].concat([0,-.5]).concat(adj),fnew[4*i]=f[i],vnew[last]=v[i].concat([1,-.5]).concat(adj),fnew[4*i+1]=last++,vnew[last]=v[i].concat([1,1.5]).concat(adj),fnew[4*i+2]=last++,vnew[last]=v[i].concat([0,1.5]).concat(adj),fnew[4*i+3]=last++,alias[i]=[last-3,last-2,last-1],j=0;4>j;j++)v1=vnew[fnew[4*i+j]],v1[tofs+2]=2*(v1[tofs]-v1[tofs+2])*texinfo.widths[i],v1[tofs+3]=2*(v1[tofs+1]-v1[tofs+3])*texinfo.textHeights[i],v1[tofs]=(texinfo.offsetsx[i]+v1[tofs]*texinfo.widths[i])/texinfo.canvasX,v1[tofs+1]=1-(texinfo.offsetsy[i]-v1[tofs+1]*texinfo.textHeights[i])/texinfo.canvasY,vnew[fnew[4*i+j]]=v1;v=vnew,obj.vertexCount=v.length,obj.f=[fnew,fnew]}else"undefined"!=typeof obj.texcoords?(tofs=stride,stride+=2,oofs=-1,v=this.cbind(v,obj.texcoords)):(tofs=-1,oofs=-1);else{tofs=stride,stride+=2,oofs=stride,stride+=2,vnew=new Array(4*v.length),fnew=new Array(4*v.length),alias=new Array(v.length);var rescale=fixed_size?72:1,size=obj.radii,s=rescale*size[0]/2;for(last=v.length,f=obj.f[0],i=0;i<v.length;i++)size.length>1&&(s=rescale*size[i]/2),vnew[i]=v[i].concat([0,0,-s,-s]),fnew[4*i]=f[i],vnew[last]=v[i].concat([1,0,s,-s]),fnew[4*i+1]=last++,vnew[last]=v[i].concat([1,1,s,s]),fnew[4*i+2]=last++,vnew[last]=v[i].concat([0,1,-s,s]),fnew[4*i+3]=last++,alias[i]=[last-3,last-2,last-1];v=vnew,obj.vertexCount=v.length,obj.f=[fnew,fnew]}if(obj.alias=alias,"undefined"!=typeof obj.userAttributes){obj.userAttribOffsets={},obj.userAttribLocations={},obj.userAttribSizes={};for(attr in obj.userAttributes)obj.userAttribLocations[attr]=gl.getAttribLocation(obj.prog,attr),obj.userAttribLocations[attr]>=0&&(obj.userAttribOffsets[attr]=stride,v=this.cbind(v,obj.userAttributes[attr]),stride=v[0].length,obj.userAttribSizes[attr]=stride-obj.userAttribOffsets[attr])}if("undefined"!=typeof obj.userUniforms){obj.userUniformLocations={};for(attr in obj.userUniforms)obj.userUniformLocations[attr]=gl.getUniformLocation(obj.prog,attr)}if(sprites_3d)for(obj.userMatrix=new CanvasMatrix4(obj.usermatrix),obj.objects=this.flatten([].concat(obj.ids)),is_lit=!1,i=0;i<obj.objects.length;i++)this.initObj(obj.objects[i]);if(is_lit&&!fixed_quads&&(obj.normLoc=gl.getAttribLocation(obj.prog,"aNorm")),nclipplanes=this.countClipplanes(),nclipplanes&&!sprites_3d)for(obj.clipLoc=[],i=0;nclipplanes>i;i++)obj.clipLoc[i]=gl.getUniformLocation(obj.prog,"vClipplane"+i);if(is_lit)for(obj.emissionLoc=gl.getUniformLocation(obj.prog,"emission"),obj.emission=new Float32Array(this.stringToRgb(this.getMaterial(id,"emission"))),obj.shininessLoc=gl.getUniformLocation(obj.prog,"shininess"),obj.shininess=this.getMaterial(id,"shininess"),obj.nlights=this.countLights(),obj.ambientLoc=[],obj.ambient=new Float32Array(this.stringToRgb(this.getMaterial(id,"ambient"))),obj.specularLoc=[],obj.specular=new Float32Array(this.stringToRgb(this.getMaterial(id,"specular"))),obj.diffuseLoc=[],obj.lightDirLoc=[],obj.viewpointLoc=[],obj.finiteLoc=[],i=0;i<obj.nlights;i++)obj.ambientLoc[i]=gl.getUniformLocation(obj.prog,"ambient"+i),obj.specularLoc[i]=gl.getUniformLocation(obj.prog,"specular"+i),obj.diffuseLoc[i]=gl.getUniformLocation(obj.prog,"diffuse"+i),obj.lightDirLoc[i]=gl.getUniformLocation(obj.prog,"lightDir"+i),obj.viewpointLoc[i]=gl.getUniformLocation(obj.prog,"viewpoint"+i),obj.finiteLoc[i]=gl.getUniformLocation(obj.prog,"finite"+i);for(obj.passes=is_twosided+1,obj.pmode=new Array(obj.passes),pass=0;pass<obj.passes;pass++)pmode="triangles"===type||"quads"===type||"surface"===type||"spheres"===type?this.getMaterial(id,0===pass?"front":"back"):"filled",obj.pmode[pass]=pmode;if("spheres"!==type)for(obj.f.length=obj.passes,pass=0;pass<obj.passes;pass++){if(f=fnew=obj.f[pass],pmode=obj.pmode[pass],"culled"===pmode)f=[];else if("points"===pmode);else if("quads"!==type&&"text"!==type&&"sprites"!==type||sprites_3d){if("triangles"===type){if(nrows=Math.floor(obj.vertexCount/3),"filled"===pmode)for(fnew=Array(3*nrows),i=0;i<fnew.length;i++)fnew[i]=f[i];else if("lines"===pmode)for(fnew=Array(6*nrows),i=0;nrows>i;i++)fnew[6*i]=f[3*i],fnew[6*i+1]=f[3*i+1],fnew[6*i+2]=f[3*i+1],fnew[6*i+3]=f[3*i+2],fnew[6*i+4]=f[3*i+2],fnew[6*i+5]=f[3*i]}else if("spheres"===type);else if("surface"===type)if(dim=obj.dim[0],nx=dim[0],nz=dim[1],"filled"===pmode)for(fnew=[],j=0;nx-1>j;j++)for(i=0;nz-1>i;i++)fnew.push(f[j+nx*i],f[j+nx*(i+1)],f[j+1+nx*(i+1)],f[j+nx*i],f[j+1+nx*(i+1)],f[j+1+nx*i]);else if("lines"===pmode)for(fnew=[],j=0;nx>j;j++)for(i=0;nz>i;i++)nz>i+1&&fnew.push(f[j+nx*i],f[j+nx*(i+1)]),nx>j+1&&fnew.push(f[j+nx*i],f[j+1+nx*i])}else if(nrows=Math.floor(obj.vertexCount/4),"filled"===pmode)for(fnew=Array(6*nrows),i=0;nrows>i;i++)fnew[6*i]=f[4*i],fnew[6*i+1]=f[4*i+1],fnew[6*i+2]=f[4*i+2],fnew[6*i+3]=f[4*i],fnew[6*i+4]=f[4*i+2],fnew[6*i+5]=f[4*i+3];else for(fnew=Array(8*nrows),i=0;nrows>i;i++)fnew[8*i]=f[4*i],fnew[8*i+1]=f[4*i+1],fnew[8*i+2]=f[4*i+1],fnew[8*i+3]=f[4*i+2],fnew[8*i+4]=f[4*i+2],fnew[8*i+5]=f[4*i+3],fnew[8*i+6]=f[4*i+3],fnew[8*i+7]=f[4*i];obj.f[pass]=fnew,drawtype=depth_sort?"DYNAMIC_DRAW":"STATIC_DRAW"}if(fat_lines){for(alias=void 0,obj.nextLoc=gl.getAttribLocation(obj.prog,"aNext"),obj.pointLoc=gl.getAttribLocation(obj.prog,"aPoint"),obj.aspectLoc=gl.getUniformLocation(obj.prog,"uAspect"),obj.lwdLoc=gl.getUniformLocation(obj.prog,"uLwd"),pass=0;pass<obj.passes&&(f=obj.f[pass],oldrows=f.length,"lines"!==obj.pmode[pass]);pass++);for(nrows="linestrip"===type?4*(oldrows-1):2*oldrows,vnew=new Array(nrows),fnew=new Array(1.5*nrows),i=0;i<v.length;i++)vnew[i]=v[i].concat([0,0,0,0,0]);nextofs=stride,pointofs=stride+3,stride+=5;var ind,k;for(last=v.length-1,ind=0,alias=new Array(f.length),i=0;i<f.length;i++)alias[i]=[];for(i=0;i<f.length-1;i++)if("linestrip"===type||i%2!==1){for(k=++last,vnew[k]=vnew[f[i]].slice(),j=0;3>j;j++)vnew[k][nextofs+j]=vnew[f[i+1]][j];for(vnew[k][pointofs]=-1,vnew[k][pointofs+1]=-1,fnew[ind]=k,last++,vnew[last]=vnew[k].slice(),vnew[last][pointofs]=1,fnew[ind+1]=last,alias[f[i]].push(last-1,last),last++,k=last,vnew[k]=vnew[f[i+1]].slice(),j=0;3>j;j++)vnew[k][nextofs+j]=vnew[f[i]][j];vnew[k][pointofs]=-1,vnew[k][pointofs+1]=1,fnew[ind+2]=k,fnew[ind+3]=fnew[ind+1],last++,vnew[last]=vnew[k].slice(),vnew[last][pointofs]=1,fnew[ind+4]=last,fnew[ind+5]=fnew[ind+2],ind+=6,alias[f[i+1]].push(last-1,last)}if(vnew.length=last+1,v=vnew,obj.vertexCount=v.length,"undefined"!=typeof alias&&"undefined"!=typeof obj.alias){var oldalias=obj.alias,newalias=Array(obj.alias.length);for(i=0;i<newalias.length;i++)for(newalias[i]=oldalias[i].slice(),j=0;j<oldalias[i].length;j++)Array.prototype.push.apply(newalias[i],alias[oldalias[j]]);obj.alias=newalias}else obj.alias=alias;for(pass=0;pass<obj.passes;pass++)("lines"===type||"linestrip"===type||"lines"===obj.pmode[pass])&&(obj.f[pass]=fnew);drawtype=depth_sort?"DYNAMIC_DRAW":"STATIC_DRAW"}for(pass=0;pass<obj.passes;pass++)obj.vertexCount>65535?this.index_uint?(obj.f[pass]=new Uint32Array(obj.f[pass]),obj.index_uint=!0):this.alertOnce("Object has "+obj.vertexCount+" vertices, not supported in this browser."):(obj.f[pass]=new Uint16Array(obj.f[pass]),obj.index_uint=!1);stride!==v[0].length&&this.alertOnce("problem in stride calculation"),obj.vOffsets={vofs:0,cofs:cofs,nofs:nofs,radofs:radofs,oofs:oofs,tofs:tofs,nextofs:nextofs,pointofs:pointofs,stride:stride},obj.values=new Float32Array(this.flatten(v)),"spheres"===type||sprites_3d||(obj.buf=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,obj.buf),gl.bufferData(gl.ARRAY_BUFFER,obj.values,gl.STATIC_DRAW),obj.ibuf=Array(obj.passes),obj.ibuf[0]=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,obj.ibuf[0]),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,obj.f[0],gl[drawtype]),is_twosided&&(obj.ibuf[1]=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,obj.ibuf[1]),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,obj.f[1],gl[drawtype]))),sprites_3d||(obj.mvMatLoc=gl.getUniformLocation(obj.prog,"mvMatrix"),obj.prMatLoc=gl.getUniformLocation(obj.prog,"prMatrix")),fixed_size&&(obj.textScaleLoc=gl.getUniformLocation(obj.prog,"textScale")),is_lit&&!sprites_3d&&(obj.normMatLoc=gl.getUniformLocation(obj.prog,"normMatrix")),is_twosided&&(obj.frontLoc=gl.getUniformLocation(obj.prog,"front"))}}},rglwidgetClass.prototype.initialize=function(el,x){if(this.textureCanvas=document.createElement("canvas"),this.textureCanvas.style.display="block",this.scene=x,this.normMatrix=new CanvasMatrix4,this.saveMat={},this.distance=null,this.posLoc=0,this.colLoc=1,el&&(el.rglinstance=this,this.el=el,this.webGLoptions=el.rglinstance.scene.webGLoptions,this.initCanvas()),"undefined"!=typeof Shiny){var self=this;Shiny.addCustomMessageHandler("shinyGetPar3d",function(message){var i,param,subscene=self.getObj(message.subscene),parameters=[].concat(message.parameters),result={tag:message.tag,subscene:message.subscene};if("undefined"!=typeof subscene)for(i=0;i<parameters.length;i++)param=parameters[i],result[param]=subscene.par3d[param];else console.log("subscene "+message.subscene+" undefined.");Shiny.setInputValue("par3d:shinyPar3d",result,{priority:"event"})}),Shiny.addCustomMessageHandler("shinySetPar3d",function(message){var param=message.parameter,subscene=self.getObj(message.subscene);"undefined"!=typeof subscene?(subscene.par3d[param]=message.value,subscene.initialized=!1,self.drawScene()):console.log("subscene "+message.subscene+" undefined.")}),Shiny.addCustomMessageHandler("resetBrush",function(message){message===self.scene.selectionInput&&(self.clearBrush(null),self.recordSelection(0))})}},rglwidgetClass.prototype.restartCanvas=function(){var newcanvas=document.createElement("canvas"),self=this;for(newcanvas.width=this.el.width,newcanvas.height=this.el.height,newcanvas.addEventListener("webglcontextrestored",this.onContextRestored,!1),newcanvas.addEventListener("webglcontextlost",this.onContextLost,!1);this.el.firstChild;)this.el.removeChild(this.el.firstChild);this.el.appendChild(newcanvas),this.canvas=newcanvas,this.setMouseHandlers(),this.gl&&Object.keys(this.scene.objects).forEach(function(key){self.getObj(parseInt(key,10)).texture=void 0}),this.gl=null},rglwidgetClass.prototype.initCanvas=function(){this.restartCanvas();var objs=this.scene.objects,self=this;if(Object.keys(objs).forEach(function(key){self.initSubscene(parseInt(key,10))}),this.setMouseHandlers(),this.onContextRestored=function(){self.initGL(),self.drawScene()},this.onContextLost=function(event){self.drawing||(this.gl=null),event.preventDefault()},this.initGL0(),this.lazyLoadScene=function(){"undefined"==typeof self.slide&&(self.slide=self.getSlide()),self.isInBrowserViewport()&&((!self.gl||self.gl.isContextLost())&&self.initGL(),self.drawScene())},window.addEventListener("DOMContentLoaded",this.lazyLoadScene,!1),window.addEventListener("load",this.lazyLoadScene,!1),window.addEventListener("resize",this.lazyLoadScene,!1),window.addEventListener("scroll",this.lazyLoadScene,!1),this.slide=this.getSlide(),this.slide&&("undefined"==typeof this.slide.rgl?this.slide.rgl=[this]:this.slide.rgl.push(this),this.scene.context.rmarkdown))if("ioslides_presentation"===this.scene.context.rmarkdown)this.slide.setAttribute("slideenter","this.rgl.forEach(function(scene) { scene.lazyLoadScene.call(window);})");else if("slidy_presentation"===this.scene.context.rmarkdown){var MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,observer=new MutationObserver(function(mutations){mutations.forEach(function(){self.slide.rgl.forEach(function(scene){scene.lazyLoadScene.call(window)})})});observer.observe(this.slide,{attributes:!0,attributeFilter:["class"]})}},rglwidgetClass.prototype.getPieces=function(context,objid,subid,obj){var depth,z,w,i,n=obj.centers.length,result=new Array(n);for(context=context.slice(),i=0;n>i;i++)z=this.prmvMatrix.m13*obj.centers[i][0]+this.prmvMatrix.m23*obj.centers[i][1]+this.prmvMatrix.m33*obj.centers[i][2]+this.prmvMatrix.m43,w=this.prmvMatrix.m14*obj.centers[i][0]+this.prmvMatrix.m24*obj.centers[i][1]+this.prmvMatrix.m34*obj.centers[i][2]+this.prmvMatrix.m44,depth=z/w,result[i]={context:context,objid:objid,subid:subid,index:i,depth:depth};return result},rglwidgetClass.prototype.getSpherePieces=function(context,subid,obj){return obj.fastTransparency?0===subid?this.getPieces(context,obj.id,-1,obj):[]:this.getPieces(context,obj.id,subid,this.sphere)},rglwidgetClass.prototype.mergePieces=function(pieces){var result=[];if(pieces.length>0){var i,thiscontext=pieces[0].context,thisobjid=pieces[0].objid,thissubid=pieces[0].subid,indices=[];for(i=0;i<pieces.length;i++)(pieces[i].context!==thiscontext||pieces[i].objid!==thisobjid||pieces[i].subid!==thissubid)&&(result.push({context:thiscontext,objid:thisobjid,subid:thissubid,indices:indices}),thiscontext=pieces[i].context,thisobjid=pieces[i].objid,thissubid=pieces[i].subid,indices=[]),indices.push(pieces[i].index);result.push({context:thiscontext,objid:thisobjid,subid:thissubid,indices:indices})}return result},rglwidgetClass.prototype.sortPieces=function(pieces){var compare=function(i,j){var diff=j.depth-i.depth;if(0===diff){var c1=j.context.slice(),c2=i.context.slice();for(diff=c1.length-c2.length;0===diff&&c1.length>0;)diff=c1.pop()-c2.pop();0===diff&&(diff=j.objid-i.objid),0===diff&&(diff=j.subid-i.subid)}return diff},result=[];return pieces.length&&(result=pieces.sort(compare)),result},rglwidgetClass.prototype.startDrawing=function(){var value=this.drawing;return this.drawing=!0,value},rglwidgetClass.prototype.stopDrawing=function(saved){this.drawing=saved,!saved&&this.gl&&this.gl.isContextLost()&&this.restartCanvas()},rglwidgetClass.prototype.planeUpdateTriangles=function(obj,bbox){var x,xrow,elem,A,d,nhits,i,j,k,u,v,w,intersect,which,v0,v2,vx,reverse,perms=[[0,0,1],[1,2,2],[2,1,0]],face1=[],face2=[],normals=[],nPlanes=obj.normals.length;for(obj.bbox=bbox,obj.vertices=[],obj.initialized=!1,elem=0;nPlanes>elem;elem++){for(x=[],A=obj.normals[elem],d=obj.offsets[elem][0],nhits=0,i=0;3>i;i++)for(j=0;2>j;j++)for(k=0;2>k;k++)u=perms[0][i],v=perms[1][i],w=perms[2][i],0!==A[w]&&(intersect=-(d+A[u]*bbox[j+2*u]+A[v]*bbox[k+2*v])/A[w],bbox[2*w]<intersect&&intersect<bbox[1+2*w]&&(xrow=[],xrow[u]=bbox[j+2*u],xrow[v]=bbox[k+2*v],xrow[w]=intersect,x.push(xrow),face1[nhits]=j+2*u,face2[nhits]=k+2*v,nhits++));if(nhits>3)for(i=0;nhits-2>i;i++){for(which=0,j=i+1;nhits>j;j++)if(face1[i]===face1[j]||face1[i]===face2[j]||face2[i]===face1[j]||face2[i]===face2[j]){which=j;break}which>i+1&&(this.swap(x,i+1,which),this.swap(face1,i+1,which),this.swap(face2,i+1,which))}if(nhits>=3)for(v0=[x[0][0]-x[1][0],x[0][1]-x[1][1],x[0][2]-x[1][2]],v2=[x[2][0]-x[1][0],x[2][1]-x[1][1],x[2][2]-x[1][2]],vx=this.xprod(v0,v2),reverse=this.dotprod(vx,A)>0,i=0;nhits-2>i;i++)for(obj.vertices.push(x[0]),normals.push(A),j=1;3>j;j++)obj.vertices.push(x[i+(reverse?3-j:j)]),normals.push(A)}obj.pnormals=normals},rglwidgetClass.prototype.mode4type={points:"POINTS",linestrip:"LINE_STRIP",abclines:"LINES",lines:"LINES",sprites:"TRIANGLES",planes:"TRIANGLES",text:"TRIANGLES",quads:"TRIANGLES",surface:"TRIANGLES",triangles:"TRIANGLES",sphere:"TRIANGLES"},rglwidgetClass.prototype.disableArrays=function(obj,enabled){var i,attr,gl=this.gl||this.initGL(),objLocs=["normLoc","texLoc","ofsLoc","pointLoc","nextLoc"],thisLocs=["posLoc","colLoc"];for(i=0;i<objLocs.length;i++)enabled[objLocs[i]]&&gl.disableVertexAttribArray(obj[objLocs[i]]);for(i=0;i<thisLocs.length;i++)enabled[thisLocs[i]]&&gl.disableVertexAttribArray(this[objLocs[i]]);if("undefined"!=typeof obj.userAttributes)for(attr in obj.userAttribSizes)gl.disableVertexAttribArray(obj.userAttribLocations[attr])},rglwidgetClass.prototype.doStartScene=function(){var gl=this.gl||this.initGL();
gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl.LEQUAL),gl.clearDepth(1),gl.clearColor(1,1,1,1),gl.depthMask(!0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)},rglwidgetClass.prototype.doDepthTest=function(obj){var gl=this.gl,tests={never:gl.NEVER,less:gl.LESS,equal:gl.EQUAL,lequal:gl.LEQUAL,greater:gl.GREATER,notequal:gl.NOTEQUAL,gequal:gl.GEQUAL,always:gl.ALWAYS},test=tests[this.getObjMaterial(obj,"depth_test")];gl.depthFunc(test)},rglwidgetClass.prototype.doPolygonOffset=function(obj){var gl=this.gl;"undefined"!=typeof obj.polygon_offset?(gl.polygonOffset(obj.polygon_offset[0],obj.polygon_offset[1]),gl.enable(gl.POLYGON_OFFSET_FILL)):gl.disable(gl.POLYGON_OFFSET_FILL)},rglwidgetClass.prototype.doClipping=function(obj,subscene){var clip,i,j,gl=this.gl,clipcheck=0,clipplaneids=subscene.clipplanes;for(i=0;i<clipplaneids.length;i++){for(clip=this.getObj(clipplaneids[i]),j=0;j<clip.offsets.length;j++)gl.uniform4fv(obj.clipLoc[clipcheck+j],clip.IMVClip[j]);clipcheck+=clip.offsets.length}if("undefined"!=typeof obj.clipLoc)for(i=clipcheck;i<obj.clipLoc.length;i++)gl.uniform4f(obj.clipLoc[i],0,0,0,0)},rglwidgetClass.prototype.doLighting=function(obj,subscene){var i,light,gl=this.gl;for(gl.uniformMatrix4fv(obj.normMatLoc,!1,new Float32Array(this.normMatrix.getAsArray())),gl.uniform3fv(obj.emissionLoc,obj.emission),gl.uniform1f(obj.shininessLoc,obj.shininess),i=0;i<subscene.lights.length;i++)light=this.getObj(subscene.lights[i]),light.initialized||this.initObj(light.id),gl.uniform3fv(obj.ambientLoc[i],this.componentProduct(light.ambient,obj.ambient)),gl.uniform3fv(obj.specularLoc[i],this.componentProduct(light.specular,obj.specular)),gl.uniform3fv(obj.diffuseLoc[i],light.diffuse),gl.uniform3fv(obj.lightDirLoc[i],light.lightDir),gl.uniform1i(obj.viewpointLoc[i],light.viewpoint),gl.uniform1i(obj.finiteLoc[i],light.finite);for(i=subscene.lights.length;i<obj.nlights;i++)gl.uniform3f(obj.ambientLoc[i],0,0,0),gl.uniform3f(obj.specularLoc[i],0,0,0),gl.uniform3f(obj.diffuseLoc[i],0,0,0)},rglwidgetClass.prototype.doColors=function(obj){var gl=this.gl;return 1===obj.colorCount?(gl.disableVertexAttribArray(this.colLoc),gl.vertexAttrib4fv(this.colLoc,new Float32Array(obj.onecolor)),!1):(gl.enableVertexAttribArray(this.colLoc),gl.vertexAttribPointer(this.colLoc,4,gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.vOffsets.cofs),!0)},rglwidgetClass.prototype.doNormals=function(obj){var gl=this.gl;return obj.vOffsets.nofs>=0?(gl.enableVertexAttribArray(obj.normLoc),gl.vertexAttribPointer(obj.normLoc,3,gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.vOffsets.nofs),!0):!1},rglwidgetClass.prototype.doTexture=function(obj){var gl=this.gl,is_spheres="spheres"===obj.type;return gl.enableVertexAttribArray(obj.texLoc),is_spheres?gl.vertexAttribPointer(obj.texLoc,2,gl.FLOAT,!1,4*this.sphere.vOffsets.stride,4*this.sphere.vOffsets.tofs):gl.vertexAttribPointer(obj.texLoc,2,gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.vOffsets.tofs),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,obj.texture),gl.uniform1i(obj.sampler,0),!0},rglwidgetClass.prototype.doUserAttributes=function(obj){if("undefined"!=typeof obj.userAttributes){var gl=this.gl;for(var attr in obj.userAttribSizes)gl.enableVertexAttribArray(obj.userAttribLocations[attr]),gl.vertexAttribPointer(obj.userAttribLocations[attr],obj.userAttribSizes[attr],gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.userAttribOffsets[attr])}},rglwidgetClass.prototype.doUserUniforms=function(obj){if("undefined"!=typeof obj.userUniforms){var gl=this.gl;for(var attr in obj.userUniformLocations){var loc=obj.userUniformLocations[attr];if(null!==loc){var uniform=obj.userUniforms[attr];if("undefined"==typeof uniform.length)gl.uniform1f(loc,uniform);else if("undefined"==typeof uniform[0].length)switch(uniform=new Float32Array(uniform),uniform.length){case 2:gl.uniform2fv(loc,uniform);break;case 3:gl.uniform3fv(loc,uniform);break;case 4:gl.uniform4fv(loc,uniform);break;default:console.warn("bad uniform length")}else 4===uniform.length&&4===uniform[0].length?gl.uniformMatrix4fv(loc,!1,new Float32Array(uniform.getAsArray())):console.warn("unsupported uniform matrix")}}}},rglwidgetClass.prototype.doLoadIndices=function(obj,pass,indices){var fnew,step,gl=this.gl,f=obj.f[pass],type=obj.type,fat_lines=this.isSet(obj.flags,this.f_fat_lines);switch(type){case"points":step=1;break;case"abclines":case"lines":step=fat_lines?6:2;break;case"linestrip":step=fat_lines?6:1;break;case"sphere":case"planes":case"triangles":step=3;break;case"text":case"sprites":case"quads":case"surface":step=6;break;default:return console.error("loadIndices for "+type),0}fnew=obj.index_uint?new Uint32Array(step*indices.length):new Uint16Array(step*indices.length);for(var i=0;i<indices.length;i++)for(var j=0;step>j;j++)fnew[step*i+j]=f[step*indices[i]+j];return gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,fnew,gl.DYNAMIC_DRAW),fnew.length},rglwidgetClass.prototype.doMasking=function(mask){var gl=this.gl;gl.depthMask(mask)},rglwidgetClass.prototype.doBlending=function(blend){var gl=this.gl;blend?(gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE),gl.enable(gl.BLEND)):gl.disable(gl.BLEND)},rglwidgetClass.prototype.doFog=function(obj,subscene){var fogmode,color,gl=this.gl,observer=subscene.par3d.observer[2],sintheta=Math.sin(subscene.par3d.FOV*Math.PI/180/2),parms=[this.frustum.near-2*observer,this.frustum.far-2*observer,this.fogScale,(1-sintheta)/(1+sintheta)];switch("undefined"==typeof this.fogType&&(this.fogType="none"),"undefined"==typeof this.fogScale&&(parms[2]=1),0===sintheta&&(parms[3]=1/3),this.fogType){case"none":fogmode=0;break;case"linear":fogmode=1;break;case"exp":fogmode=2;break;case"exp2":fogmode=3;break;default:console.error("Unknown fogtype "+this.fogType)}gl.uniform1i(obj.uFogMode,fogmode),color=this.fogColor,gl.uniform3f(obj.uFogColor,color[0],color[1],color[2]),gl.uniform4f(obj.uFogParms,parms[0],parms[1],parms[2],parms[3])},rglwidgetClass.prototype.drawSimple=function(obj,subscene,context){var count,pass,mode,pmode,flags=obj.flags,type=obj.type,is_lit=this.isSet(flags,this.f_is_lit),has_texture=this.isSet(flags,this.f_has_texture),is_transparent=this.isSet(flags,this.f_is_transparent),fixed_size=this.isSet(flags,this.f_fixed_size),fixed_quads=this.isSet(flags,this.f_fixed_quads),is_lines=this.isSet(flags,this.f_is_lines),fat_lines=this.isSet(flags,this.f_fat_lines),is_twosided=this.isSet(flags,this.f_is_twosided),has_fog=this.isSet(flags,this.f_has_fog),gl=this.gl||this.initGL(),enabled={};if(obj.initialized||this.initObj(obj.id),count=obj.vertexCount,!count)return[];if(is_transparent=is_transparent||obj.someHidden,is_transparent&&this.opaquePass)return this.getPieces(context,obj.id,0,obj);for(this.doDepthTest(obj),this.doMasking(this.getObjMaterial(obj,"depth_mask")),gl.useProgram(obj.prog),this.doPolygonOffset(obj),gl.bindBuffer(gl.ARRAY_BUFFER,obj.buf),gl.uniformMatrix4fv(obj.prMatLoc,!1,new Float32Array(this.prMatrix.getAsArray())),gl.uniformMatrix4fv(obj.mvMatLoc,!1,new Float32Array(this.mvMatrix.getAsArray())),this.doClipping(obj,subscene),is_lit&&this.doLighting(obj,subscene),has_fog&&this.doFog(obj,subscene),this.doUserAttributes(obj),this.doUserUniforms(obj),gl.enableVertexAttribArray(this.posLoc),enabled.posLoc=!0,(has_texture||"text"===obj.type)&&(enabled.texLoc=this.doTexture(obj)),enabled.colLoc=this.doColors(obj),is_lit&&(enabled.normLoc=this.doNormals(obj)),fixed_size&&gl.uniform2f(obj.textScaleLoc,.75/this.vp.width,.75/this.vp.height),fixed_quads&&(gl.enableVertexAttribArray(obj.ofsLoc),enabled.ofsLoc=!0,gl.vertexAttribPointer(obj.ofsLoc,2,gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.vOffsets.oofs)),pass=0;pass<obj.passes;pass++)pmode=obj.pmode[pass],"culled"!==pmode&&(mode=fat_lines&&(is_lines||"lines"===pmode)?"TRIANGLES":this.mode4type[type],is_twosided&&gl.uniform1i(obj.frontLoc,0!==pass),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,obj.ibuf[pass]),this.opaquePass?(count=obj.f[pass].length,gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,obj.f[pass],gl.STATIC_DRAW)):count="sphere"===type&&obj.fastTransparency?this.doLoadIndices(obj,pass,this.sphere.fastpieces[0].indices):this.doLoadIndices(obj,pass,context.indices),is_lines||"lines"!==pmode||fat_lines?"points"===pmode&&(mode="POINTS"):mode="LINES",(is_lines||"lines"===pmode)&&fat_lines&&(gl.enableVertexAttribArray(obj.pointLoc),enabled.pointLoc=!0,gl.vertexAttribPointer(obj.pointLoc,2,gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.vOffsets.pointofs),gl.enableVertexAttribArray(obj.nextLoc),enabled.nextLoc=!0,gl.vertexAttribPointer(obj.nextLoc,3,gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.vOffsets.nextofs),gl.uniform1f(obj.aspectLoc,this.vp.width/this.vp.height),gl.uniform1f(obj.lwdLoc,this.getMaterial(obj.id,"lwd")/this.vp.height)),gl.vertexAttribPointer(this.posLoc,3,gl.FLOAT,!1,4*obj.vOffsets.stride,4*obj.vOffsets.vofs),gl.drawElements(gl[mode],count,obj.index_uint?gl.UNSIGNED_INT:gl.UNSIGNED_SHORT,0));return this.disableArrays(obj,enabled),[]},rglwidgetClass.prototype.drawPlanes=function(obj,subscene,context){return obj.bbox===subscene.par3d.bbox&&obj.initialized||this.planeUpdateTriangles(obj,subscene.par3d.bbox),this.drawSimple(obj,subscene,context)},rglwidgetClass.prototype.drawSpheres=function(obj,subscene,context){var sphereMV,baseofs,ofs,sscale,i,count,nc,scount,scale,indices,sphereNorm,drawing,idx,flags=obj.flags,is_transparent=this.isSet(flags,this.f_is_transparent),enabled={},saveNorm=new CanvasMatrix4(this.normMatrix),saveMV=new CanvasMatrix4(this.mvMatrix),savePRMV=null,result=[];if(obj.initialized||this.initObj(obj.id),count=obj.vertexCount,!count)return result;if(is_transparent=is_transparent||obj.someHidden,!this.opaquePass&&!is_transparent)return result;for(null!==this.prmvMatrix&&(savePRMV=new CanvasMatrix4(this.prmvMatrix)),scale=subscene.par3d.scale,sphereNorm=new CanvasMatrix4,sphereNorm.scale(scale[0],scale[1],scale[2]),sphereNorm.multRight(saveNorm),this.normMatrix=sphereNorm,this.opaquePass&&(context=context.slice(),context.push(obj.id)),drawing=this.opaquePass!==is_transparent,drawing&&(nc=obj.colorCount,1===nc&&(this.sphere.onecolor=obj.onecolor)),this.initSphereFromObj(obj),!this.opaquePass&&obj.fastTransparency&&"undefined"==typeof this.sphere.fastpieces&&(this.sphere.fastpieces=this.getPieces(context.context,obj.id,0,this.sphere),this.sphere.fastpieces=this.sortPieces(this.sphere.fastpieces),this.sphere.fastpieces=this.mergePieces(this.sphere.fastpieces)),this.opaquePass?scount=count:(indices=context.indices,scount=obj.fastTransparency?indices.length:1),i=0;scount>i;i++)sphereMV=new CanvasMatrix4,idx=this.opaquePass?i:obj.fastTransparency?indices[i]:context.subid,"undefined"==typeof idx&&console.error("idx is undefined"),baseofs=idx*obj.vOffsets.stride,ofs=baseofs+obj.vOffsets.radofs,sscale=obj.values[ofs],sphereMV.scale(sscale/scale[0],sscale/scale[1],sscale/scale[2]),sphereMV.translate(obj.values[baseofs],obj.values[baseofs+1],obj.values[baseofs+2]),sphereMV.multRight(saveMV),this.mvMatrix=sphereMV,this.setprmvMatrix(),drawing?(nc>1&&(this.sphere.onecolor=this.flatten(obj.sphereColors[idx%obj.sphereColors.length])),this.drawSimple(this.sphere,subscene,context)):result=result.concat(this.getSpherePieces(context,i,obj));return drawing&&this.disableArrays(obj,enabled),this.normMatrix=saveNorm,this.mvMatrix=saveMV,this.prmvMatrix=savePRMV,result},rglwidgetClass.prototype.drawClipplanes=function(obj){for(var count=obj.offsets.length,IMVClip=[],i=0;count>i;i++)IMVClip[i]=this.multMV(this.invMatrix,obj.vClipplane.slice(4*i,4*(i+1)));return obj.IMVClip=IMVClip,[]},rglwidgetClass.prototype.drawLinestrip=function(obj,subscene,context){var origIndices,i,j;if(this.opaquePass)return this.drawSimple(obj,subscene,context);for(origIndices=context.indices.slice(),i=0;i<origIndices.length;i++)j=origIndices[i],j<obj.centers.length-1&&(context.indices=[j,j+1],this.drawSimple(obj,subscene,context));return context.indices=origIndices,[]},rglwidgetClass.prototype.drawSprites=function(obj,subscene,context){var i,j,pos,radius,userMatrix,flags=obj.flags,is_transparent=this.isSet(flags,this.f_is_transparent),sprites3d=this.isSet(flags,this.f_sprites_3d),origMV=new CanvasMatrix4(this.mvMatrix),origPRMV=null,result=[];if(!sprites3d)return this.drawSimple(obj,subscene,context);if(obj.initialized||this.initObj(obj.id),!obj.vertexCount)return result;is_transparent=is_transparent||obj.someHidden;var iOrig,norigs=obj.vertices.length,savenorm=new CanvasMatrix4(this.normMatrix);for(this.normMatrix=subscene.spriteNormmat,userMatrix=obj.userMatrix,this.opaquePass?(context=context.slice(),context.push(obj.id)):norigs=1,null!==this.prmvMatrix&&(origPRMV=new CanvasMatrix4(this.prmvMatrix)),iOrig=0;norigs>iOrig;iOrig++)for(j=this.opaquePass?iOrig:context.subid,pos=this.multVM([].concat(obj.vertices[j]).concat(1),origMV),radius=obj.radii.length>1?obj.radii[j][0]:obj.radii[0][0],this.mvMatrix=new CanvasMatrix4(userMatrix),this.mvMatrix.scale(radius),this.mvMatrix.translate(pos[0]/pos[3],pos[1]/pos[3],pos[2]/pos[3]),this.setprmvMatrix(),i=0;i<obj.objects.length;i++)this.opaquePass?result=result.concat(this.drawObjId(obj.objects[i],subscene.id,context.concat(j))):this.drawObjId(obj.objects[i],subscene.id,context);return this.normMatrix=savenorm,this.mvMatrix=origMV,null!==origPRMV&&(this.prmvMatrix=origPRMV),result},rglwidgetClass.prototype.drawObjId=function(id,subsceneid,context){return"number"!=typeof id&&this.alertOnce("drawObjId id is "+typeof id),this.drawObj(this.getObj(id),this.getObj(subsceneid),context)},rglwidgetClass.prototype.drawObj=function(obj,subscene,context){switch(obj.type){case"abclines":case"surface":case"triangles":case"quads":case"lines":case"points":case"text":return this.drawSimple(obj,subscene,context);case"linestrip":return this.drawLinestrip(obj,subscene,context);case"planes":return this.drawPlanes(obj,subscene,context);case"spheres":return this.drawSpheres(obj,subscene,context);case"clipplanes":return this.drawClipplanes(obj);case"sprites":return this.drawSprites(obj,subscene,context);case"light":case"bboxdeco":return[]}console.error("drawObj for type = "+obj.type)},rglwidgetClass.prototype.drawBackground=function(id,subsceneid){var bg,i,savepr,savemv,gl=this.gl||this.initGL(),obj=this.getObj(id);if(obj.initialized||this.initObj(id),obj.colors.length?(bg=obj.colors[0],gl.clearColor(bg[0],bg[1],bg[2],bg[3]),gl.depthMask(!0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),this.fogColor=bg):this.fogColor=[0,0,0,0],this.fogType=obj.fogtype,this.fogScale=obj.fogscale,"undefined"!=typeof obj.quad){for(savepr=this.prMatrix,savemv=this.mvMatrix,this.prMatrix=new CanvasMatrix4,this.mvMatrix=new CanvasMatrix4,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.depthMask(!1),i=0;i<obj.quad.length;i++)this.drawObjId(obj.quad[i],subsceneid);this.prMatrix=savepr,this.mvMatrix=savemv}},rglwidgetClass.prototype.drawSubscene=function(subsceneid,context){var flags,i,obj,sub=this.getObj(subsceneid),objects=this.scene.objects,clipids=sub.clipplanes,subids=sub.objects,subscene_has_faces=!1,subscene_needs_sorting=!1,result=[];if(sub.par3d.skipRedraw)return result;if(this.opaquePass)for(i=0;i<subids.length;i++)obj=objects[subids[i]],flags=obj.flags,"undefined"!=typeof flags&&(subscene_has_faces=subscene_has_faces||this.isSet(flags,this.f_is_lit)&&!this.isSet(flags,this.f_fixed_quads),obj.is_transparent=obj.someHidden||this.isSet(flags,this.f_is_transparent),subscene_needs_sorting=subscene_needs_sorting||obj.is_transparent||this.isSet(flags,this.f_depth_sort));if(this.setViewport(subsceneid),this.setprMatrix(subsceneid),this.setmvMatrix(subsceneid),"undefined"!=typeof sub.backgroundId&&this.opaquePass&&this.drawBackground(sub.backgroundId,subsceneid),subids.length){if(subscene_has_faces&&(this.setnormMatrix(subsceneid),this.isSet(sub.flags,this.f_sprites_3d)&&"undefined"==typeof sub.spriteNormmat&&(sub.spriteNormmat=new CanvasMatrix4(this.normMatrix))),subscene_needs_sorting&&this.setprmvMatrix(),clipids.length>0)for(this.invMatrix=new CanvasMatrix4(this.mvMatrix),this.invMatrix.invert(),i=0;i<clipids.length;i++)this.drawObjId(clipids[i],subsceneid);if(subids=sub.opaque.concat(sub.transparent),this.opaquePass){for(context=context.slice(),context.push(subsceneid),this.doBlending(!1),this.subsceneid=subsceneid,"undefined"!=typeof this.sphere&&(this.sphere.fastpieces=void 0),i=0;i<subids.length;i++)result=result.concat(this.drawObjId(subids[i],subsceneid,context));for(subids=sub.subscenes,i=0;i<subids.length;i++)result=result.concat(this.drawSubscene(subids[i],context))}}return result},rglwidgetClass.prototype.setContext=function(context){var objid,obj,type,result=[];for(context=context.slice(),context.reverse();context.length>0;)switch(objid=context.pop(),obj=this.getObj(objid),type=obj.type){case"subscene":this.drawSubscene(objid,!1);break;case"sprites":result=result.concat(context.pop());break;case"spheres":break;default:console.error("bad type '",type,"' in setContext")}return result},rglwidgetClass.prototype.drawPieces=function(pieces){var i,context,prevcontext=[];for(this.doBlending(!0),i=0;i<pieces.length;i++)context=pieces[i].context.slice(),context!==prevcontext&&(prevcontext=context.slice(),context=this.setContext(context)),this.drawObjId(pieces[i].objid,this.subsceneid,pieces[i])},rglwidgetClass.prototype.drawScene=function(){var pieces,wasDrawing=this.startDrawing();wasDrawing||("inactive"!==this.select.state&&this.selectionChanged(),this.doStartScene(),this.opaquePass=!0,pieces=this.drawSubscene(this.scene.rootSubscene,[]),this.opaquePass=!1,pieces=this.sortPieces(pieces),pieces=this.mergePieces(pieces),this.drawPieces(pieces)),this.stopDrawing(wasDrawing)},rglwidgetClass.prototype.subsetSetter=function(el,control){("undefined"==typeof control.subscenes||null===control.subscenes)&&(control.subscenes=this.scene.rootSubscene);var i,j,subsceneid,value=Math.round(control.value),subscenes=[].concat(control.subscenes),fullset=[].concat(control.fullset),adds=[],deletes=[];if(isNaN(value)&&(value=control.value=0),control.accumulate)for(i=0;value>=i;i++)adds=adds.concat(control.subsets[i]);else adds=adds.concat(control.subsets[value]);for(deletes=fullset.filter(function(x){return adds.indexOf(x)<0}),i=0;i<subscenes.length;i++){for(subsceneid=subscenes[i],"undefined"==typeof this.getObj(subsceneid)&&this.alertOnce("typeof object is undefined"),j=0;j<adds.length;j++)this.addToSubscene(adds[j],subsceneid);for(j=0;j<deletes.length;j++)this.delFromSubscene(deletes[j],subsceneid)}},rglwidgetClass.prototype.propertySetter=function(el,control){var property,propvals,i,j,v1,v2,p,entry,gl,needsBinding,newprop,newid,value=control.value,values=[].concat(control.values),svals=[].concat(control.param),direct=null===values[0],entries=[].concat(control.entries),ncol=entries.length,nrow=values.length/ncol,properties=this.repeatToLen(control.properties,ncol),objids=this.repeatToLen(control.objids,ncol),objid=objids[0],obj=this.getObj(objid),getPropvals=function(){return"userMatrix"===property?obj.par3d.userMatrix.getAsArray():[].concat("scale"===property||"FOV"===property||"zoom"===property?obj.par3d[property]:obj[property])},putPropvals=function(newvals){1===newvals.length&&(newvals=newvals[0]),"userMatrix"===property?obj.par3d.userMatrix.load(newvals):"scale"===property||"FOV"===property||"zoom"===property?obj.par3d[property]=newvals:obj[property]=newvals};if(!direct||"undefined"!=typeof value){if(control.interp){for(values=values.slice(0,ncol).concat(values).concat(values.slice(ncol*(nrow-1),ncol*nrow)),svals=[-1/0].concat(svals).concat(1/0),i=1;i<svals.length;i++)if(value<=svals[i]){p=1/0===svals[i]?1:(svals[i]-value)/(svals[i]-svals[i-1]);break}}else direct||(value=Math.round(value));for(j=0;j<entries.length;j++)entry=entries[j],newprop=properties[j],newid=objids[j],(newprop!==property||newid!==objid)&&("undefined"!=typeof property&&putPropvals(propvals),property=newprop,objid=newid,obj=this.getObj(objid),propvals=getPropvals()),control.interp?(v1=values[ncol*(i-1)+j],v2=values[ncol*i+j],this.setElement(propvals,entry,p*v1+(1-p)*v2)):direct?this.setElement(propvals,entry,value[j]):this.setElement(propvals,entry,values[ncol*value+j]);for(putPropvals(propvals),needsBinding=[],j=0;j<entries.length;j++)"values"===properties[j]&&-1===needsBinding.indexOf(objids[j])&&needsBinding.push(objids[j]);for(j=0;j<needsBinding.length;j++)gl=this.gl||this.initGL(),obj=this.getObj(needsBinding[j]),gl.bindBuffer(gl.ARRAY_BUFFER,obj.buf),gl.bufferData(gl.ARRAY_BUFFER,obj.values,gl.STATIC_DRAW)}},rglwidgetClass.prototype.vertexSetter=function(el,control){var j,k,p,a,propvals,stride,ofs,obj,entry,attrib,vertex,varies,ncol,newval,aliases,alias,svals=[].concat(control.param),ofss={x:"vofs",y:"vofs",z:"vofs",red:"cofs",green:"cofs",blue:"cofs",alpha:"cofs",radii:"radofs",nx:"nofs",ny:"nofs",nz:"nofs",ox:"oofs",oy:"oofs",oz:"oofs",ts:"tofs",tt:"tofs"},pos={x:0,y:1,z:2,red:0,green:1,blue:2,alpha:3,radii:0,nx:0,ny:1,nz:2,ox:0,oy:1,oz:2,ts:0,tt:1},values=control.values,direct=null===values,interp=control.interp,vertices=[].concat(control.vertices),attributes=[].concat(control.attributes),value=control.value;if(ncol=Math.max(vertices.length,attributes.length)){for(vertices=this.repeatToLen(vertices,ncol),attributes=this.repeatToLen(attributes,ncol),direct&&(interp=!1),svals[0]=-1/0,svals[svals.length-1]=1/0,j=1;j<svals.length;j++)if(value<=svals[j]){interp?p=1/0===svals[j]?1:(svals[j]-value)/(svals[j]-svals[j-1]):svals[j]-value>value-svals[j-1]&&(j-=1);break}if(obj=this.getObj(control.objid),"undefined"!=typeof obj.vOffsets){for(varies=!0,k=0;ncol>k;k++)if(attrib=attributes[k],"undefined"!=typeof attrib&&(ofs=obj.vOffsets[ofss[attrib]],0>ofs)){switch(attrib){case"alpha":case"red":case"green":case"blue":obj.colors=[obj.colors[0],obj.colors[0]]}varies=!1}varies||this.initObj(control.objid)}for(propvals=obj.values,aliases=obj.alias,"undefined"==typeof aliases&&(aliases=[]),k=0;ncol>k;k++)if(newval=direct?value:interp?p*values[j-1][k]+(1-p)*values[j][k]:values[j][k],attrib=attributes[k],vertex=vertices[k],alias=aliases[vertex],("planes"===obj.type||"clipplanes"===obj.type)&&(ofs=["nx","ny","nz","offset"].indexOf(attrib),ofs>=0))3>ofs?obj.normals[vertex][ofs]!==newval&&(obj.normals[vertex][ofs]=newval,obj.initialized=!1):obj.offsets[vertex][0]!==newval&&(obj.offsets[vertex][0]=newval,obj.initialized=!1);else if(ofs=obj.vOffsets[ofss[attrib]],0>ofs)this.alertOnce("Attribute '"+attrib+"' not found in object "+control.objid);else if(stride=obj.vOffsets.stride,ofs+=pos[attrib],entry=vertex*stride+ofs,propvals[entry]=newval,"undefined"!=typeof alias)for(a=0;a<alias.length;a++)propvals[alias[a]*stride+ofs]=newval;if("undefined"!=typeof obj.buf){var gl=this.gl||this.initGL();gl.bindBuffer(gl.ARRAY_BUFFER,obj.buf),gl.bufferData(gl.ARRAY_BUFFER,propvals,gl.STATIC_DRAW)}}},rglwidgetClass.prototype.ageSetter=function(el,control){var i,k,l,age,j0,propvals,stride,ofs,objid,obj,attrib,dim,varies,alias,aliases,a,d,objids=[].concat(control.objids),nobjs=objids.length,time=control.value,births=[].concat(control.births),ages=[].concat(control.ages),steps=births.length,j=Array(steps),p=Array(steps),attribs=["colors","alpha","radii","vertices","normals","origins","texcoords","x","y","z","red","green","blue"],ofss=["cofs","cofs","radofs","vofs","nofs","oofs","tofs","vofs","vofs","vofs","cofs","cofs","cofs"],dims=[3,1,1,3,3,2,2,1,1,1,1,1,1],pos=[0,3,0,0,0,0,0,0,1,2,0,1,2];for(ages[0]=-1/0,ages[ages.length-1]=1/0,i=0;steps>i;i++)if(null!==births[i]){for(age=time-births[i],j0=1;age>ages[j0];j0++);p[i]=1/0===ages[j0]?1:ages[j0]>ages[j0-1]?(ages[j0]-age)/(ages[j0]-ages[j0-1]):0,j[i]=j0}for(l=0;nobjs>l;l++)if(objid=objids[l],obj=this.getObj(objid),varies=!0,"undefined"!=typeof obj.vOffsets){for(k=0;k<attribs.length;k++)if(attrib=control[attribs[k]],"undefined"!=typeof attrib&&(ofs=obj.vOffsets[ofss[k]],0>ofs)){switch(attribs[k]){case"colors":case"alpha":case"red":case"green":case"blue":obj.colors=[obj.colors[0],obj.colors[0]]}varies=!1}varies||this.initObj(objid)}for(l=0;nobjs>l;l++)if(objid=objids[l],obj=this.getObj(objid),"undefined"!=typeof obj.vOffsets){for(aliases=obj.alias,"undefined"==typeof aliases&&(aliases=[]),propvals=obj.values,stride=obj.vOffsets.stride,k=0;k<attribs.length;k++)if(attrib=control[attribs[k]],"undefined"!=typeof attrib)if(ofs=obj.vOffsets[ofss[k]],ofs>=0){for(dim=dims[k],ofs+=pos[k],i=0;steps>i;i++)if(alias=aliases[i],null!==births[i])for(d=0;dim>d;d++)if(propvals[i*stride+ofs+d]=p[i]*attrib[dim*(j[i]-1)+d]+(1-p[i])*attrib[dim*j[i]+d],"undefined"!=typeof alias)for(a=0;a<alias.length;a++)propvals[alias[a]*stride+ofs+d]=propvals[i*stride+ofs+d]}else this.alertOnce("'"+attribs[k]+"' property not found in object "+objid);if(obj.values=propvals,"undefined"!=typeof obj.buf){var gl=this.gl||this.initGL();gl.bindBuffer(gl.ARRAY_BUFFER,obj.buf),gl.bufferData(gl.ARRAY_BUFFER,obj.values,gl.STATIC_DRAW)}}},rglwidgetClass.prototype.oldBridge=function(el,control){var attrname,global=window[control.prefix+"rgl"];if(global)for(attrname in global)this[attrname]=global[attrname];window[control.prefix+"rgl"]=this},rglwidgetClass.prototype.Player=function(el,control){var self=this,components=[].concat(control.components),buttonLabels=[].concat(control.buttonLabels),Tick=function(){var i,step,nominal=this.value,slider=this.Slider,labels=this.outputLabels,output=this.Output;for("undefined"!=typeof slider&&nominal!==slider.value&&(slider.value=nominal),"undefined"!=typeof output&&(step=Math.round((nominal-output.sliderMin)/output.sliderStep),null!==labels?output.innerHTML=labels[step]:(step=step*output.sliderStep+output.sliderMin,output.innerHTML=step.toPrecision(output.outputPrecision))),i=0;i<this.actions.length;i++)this.actions[i].value=nominal;self.applyControls(el,this.actions,!1),self.drawScene()},OnSliderInput=function(){this.rgltimer.value=Number(this.value),this.rgltimer.Tick()},addSlider=function(min,max,step,value){var slider=document.createElement("input");slider.type="range",slider.min=min,slider.max=max,slider.step=step,slider.value=value,slider.oninput=OnSliderInput,slider.sliderActions=control.actions,slider.sliderScene=this,slider.className="rgl-slider",slider.id=el.id+"-slider",el.rgltimer.Slider=slider,slider.rgltimer=el.rgltimer,el.appendChild(slider)},addLabel=function(labels,min,step,precision){var output=document.createElement("output");output.sliderMin=min,output.sliderStep=step,output.outputPrecision=precision,output.className="rgl-label",output.id=el.id+"-label",el.rgltimer.Output=output,el.rgltimer.outputLabels=labels,el.appendChild(output)},addButton=function(which,label,active){var button=document.createElement("input"),onclicks={Reverse:function(){this.rgltimer.reverse()},Play:function(){this.rgltimer.play(),this.value=this.rgltimer.enabled?this.inactiveValue:this.activeValue},Slower:function(){this.rgltimer.slower()},Faster:function(){this.rgltimer.faster()},Reset:function(){this.rgltimer.reset()},Step:function(){this.rgltimer.step()}};button.rgltimer=el.rgltimer,button.type="button",button.value=label,button.activeValue=label,button.inactiveValue=active,"Play"===which&&(button.rgltimer.PlayButton=button),button.onclick=onclicks[which],button.className="rgl-button",button.id=el.id+"-"+which,el.appendChild(button)};"undefined"!=typeof control.reinit&&null!==control.reinit&&(control.actions.reinit=control.reinit),el.rgltimer=new rgltimerClass(Tick,control.start,control.interval,control.stop,control.step,control.value,control.rate,control.loop,control.actions);for(var i=0;i<components.length;i++)switch(components[i]){case"Slider":addSlider(control.start,control.stop,control.step,control.value);break;case"Label":addLabel(control.labels,control.start,control.step,control.precision);break;default:addButton(components[i],buttonLabels[i],control.pause)}el.rgltimer.Tick()},rglwidgetClass.prototype.applyControls=function(el,x,draw){var i,control,type,self=this,reinit=x.reinit;for(i=0;i<x.length;i++)control=x[i],type=control.type,self[type](el,control);if("undefined"!=typeof reinit&&null!==reinit)for(reinit=[].concat(reinit),i=0;i<reinit.length;i++)self.getObj(reinit[i]).initialized=!1;("undefined"==typeof draw||draw)&&self.drawScene()},rglwidgetClass.prototype.sceneChangeHandler=function(message){var deletes,subs,i,j,self=document.getElementById(message.elementId).rglinstance,objs=message.objects,mat=message.material,root=message.rootSubscene,initSubs=message.initSubscenes,redraw=message.redrawScene,skipRedraw=message.skipRedraw,allsubs=[];if("undefined"!=typeof message["delete"])for(deletes=[].concat(message["delete"]),subs="undefined"!=typeof message.delfromSubscenes?[].concat(message.delfromSubscenes):[],i=0;i<deletes.length;i++){for(j=0;j<subs.length;j++)self.delFromSubscene(deletes[i],subs[j]);delete self.scene.objects[deletes[i]]}for("undefined"!=typeof objs&&Object.keys(objs).forEach(function(key){key=parseInt(key,10),self.scene.objects[key]=objs[key],self.initObj(key);var k,obj=self.getObj(key),subs=[].concat(obj.inSubscenes);for(allsubs=allsubs.concat(subs),k=0;k<subs.length;k++)self.addToSubscene(key,subs[k])}),"undefined"!=typeof mat&&(self.scene.material=mat),"undefined"!=typeof root&&(self.scene.rootSubscene=root),"undefined"!=typeof initSubs&&(allsubs=allsubs.concat(initSubs)),allsubs=self.unique(allsubs),i=0;i<allsubs.length;i++)self.initSubscene(allsubs[i]);"undefined"!=typeof skipRedraw&&(root=self.getObj(self.scene.rootSubscene),root.par3d.skipRedraw=skipRedraw),redraw&&self.drawScene()},rglwidgetClass.prototype.selectionChanged=function(){var i,j,k,id,subscene,objids,obj,filter,handle,keys,xmin,x,xmax,ymin,y,ymax,z,v,someHidden,subid=this.select.subscene,p1=this.select.region.p1,p2=this.select.region.p2,selection=[];if(subid)for(subscene=this.getObj(subid),objids=subscene.objects,filter=this.scene.crosstalk.filter,this.setmvMatrix(subid),this.setprMatrix(subid),this.setprmvMatrix(),xmin=Math.min(p1.x,p2.x),xmax=Math.max(p1.x,p2.x),ymin=Math.min(p1.y,p2.y),ymax=Math.max(p1.y,p2.y),i=0;i<objids.length;i++)if(id=objids[i],j=this.scene.crosstalk.id.indexOf(id),j>=0){for(keys=this.scene.crosstalk.key[j],obj=this.getObj(id),someHidden=!1,k=0;k<keys.length;k++)filter&&filter.indexOf(keys[k])<0?someHidden=!0:(v=[].concat(obj.vertices[k]).concat(1),v=this.multVM(v,this.prmvMatrix),x=v[0]/v[3],y=v[1]/v[3],z=v[2]/v[3],x>=xmin&&xmax>=x&&y>=ymin&&ymax>=y&&z>=-1&&1>=z?selection.push(keys[k]):someHidden=!0);obj.someHidden=someHidden&&(filter||selection.length),obj.initialized=!1,this.equalArrays(selection,this.scene.crosstalk.selection)||(handle=this.scene.crosstalk.sel_handle[j],handle.set(selection,{rglSubsceneId:this.select.subscene}))}},rglwidgetClass.prototype.selection=function(event,filter){var i,j,ids,obj,keys,selection,someHidden,crosstalk=this.scene.crosstalk;for(crosstalk=this.scene.crosstalk,filter?(filter=crosstalk.filter=event.value,selection=crosstalk.selection):(selection=crosstalk.selection=event.value,filter=crosstalk.filter),ids=crosstalk.id,i=0;i<ids.length;i++){for(obj=this.getObj(ids[i]),obj.initialized=!1,keys=crosstalk.key[i],someHidden=!1,j=0;j<keys.length&&!someHidden;j++)(filter&&filter.indexOf(keys[j])<0||selection.length&&selection.indexOf(keys[j])<0)&&(someHidden=!0);obj.someHidden=someHidden}this.drawScene()},rglwidgetClass.prototype.clearBrush=function(except){this.select.subscene!==except&&(this.select.region={p1:{x:1/0,y:1/0},p2:{x:1/0,y:1/0}},this.selectionChanged(),this.select.state="inactive",this.delFromSubscene(this.scene.brushId,this.select.subscene)),this.drawScene()},rglwidgetClass.prototype.initSelection=function(id){if("undefined"!=typeof this.select.region){var obj=this.getObj(id),p1=this.select.region.p1,p2=this.select.region.p2;obj.vertices=[[p1.x,p1.y,0],[p2.x,p1.y,0],[p2.x,p2.y,0],[p1.x,p2.y,0],[p1.x,p1.y,0]]}},rgltimerClass=function(Tick,startTime,interval,stopTime,stepSize,value,rate,loop,actions){this.enabled=!1,this.timerId=0,this.startTime=startTime,this.value=value,this.interval=interval,this.stopTime=stopTime,this.stepSize=stepSize,this.rate=rate,this.loop=loop,this.realStart=void 0,this.multiplier=1,this.actions=actions,this.Tick=Tick
},rgltimerClass.prototype.play=function(){if(this.enabled)return this.enabled=!1,window.clearInterval(this.timerId),void(this.timerId=0);var tick=function(self){var now=new Date;self.value=self.multiplier*self.rate*(now-self.realStart)/1e3+self.startTime,self.forceToRange(),"undefined"!=typeof self.Tick&&self.Tick(self.value)};this.realStart=new Date-1e3*(this.value-this.startTime)/this.rate/this.multiplier,this.timerId=window.setInterval(tick,1e3*this.interval,this),this.enabled=!0},rgltimerClass.prototype.forceToRange=function(){if(this.value>this.stopTime+this.stepSize/2||this.value<this.startTime-this.stepSize/2)if(this.loop){var cycle=this.stopTime-this.startTime+this.stepSize,newval=(this.value-this.startTime)%cycle+this.startTime;newval<this.startTime&&(newval+=cycle),this.realStart+=1e3*(this.value-newval)/this.multiplier/this.rate,this.value=newval}else this.reset()},rgltimerClass.prototype.reset=function(){this.value=this.startTime,this.newmultiplier(1),"undefined"!=typeof this.Tick&&this.Tick(this.value),this.enabled&&this.play(),"undefined"!=typeof this.PlayButton&&(this.PlayButton.value="Play")},rgltimerClass.prototype.faster=function(){this.newmultiplier(Math.SQRT2*this.multiplier)},rgltimerClass.prototype.slower=function(){this.newmultiplier(this.multiplier/Math.SQRT2)},rgltimerClass.prototype.reverse=function(){this.newmultiplier(-this.multiplier)},rgltimerClass.prototype.newmultiplier=function(newmult){newmult!==this.multiplier&&(this.realStart+=1e3*(this.value-this.startTime)/this.rate*(1/this.multiplier-1/newmult),this.multiplier=newmult)},rgltimerClass.prototype.step=function(){this.value+=this.rate*this.multiplier,this.forceToRange(),"undefined"!=typeof this.Tick&&this.Tick(this.value)};
