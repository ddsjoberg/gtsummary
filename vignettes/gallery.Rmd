---
title: "gtsummary Gallery"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{gallery}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval = TRUE,
  comment = "#>"
)

# installing gt 
if (curl::has_internet()) {
  # adding tmpdir to libPath
  temp_path <- file.path(tempdir(), "gt_folder")
  dir.create(temp_path)
  lib_path <-.libPaths()
  .libPaths(c(lib_path, temp_path))
  
  # installing gt
  remotes::install_github("rstudio/gt", lib = temp_path)
}
```

Gallery showing various tables possible with the {gtsummary} package.  If you have created an interesting and non-standard table, please submit it to the gallery via a pull request.

1. Cox model with categorical predictors, showing the distribution of the predictor to the right.
1. ANCOVA model results

```{r, echo=FALSE, comment=""}
if (!requireNamespace("gt", quietly = TRUE)) {
  usethis::ui_oops(paste(
    "The gt package is required to build the gtsummary gallery,",
    "and was not available\non this platform during the",
    "package building process. To view the gallery,",
    "visit the package website.\n\n",
    "{usethis::ui_path('http://www.danieldsjoberg.com/gtsummary/')}"
  ))
  knitr::knit_exit()
}
```

```{r setup, message = FALSE}
library(gtsummary)
library(gt)
library(survival)
library(dplyr)
library(stringr)
library(purrr)
library(forcats)
```

---

## Summary Tables

Add a spanning header over the group columns for increased clarity.
```{r}
trial[c("trt", "age", "grade")] %>%
  tbl_summary(by = trt, missing = "no") %>%
  modify_header(stat_by = md("**{level}** N =  {n} ({style_percent(p)}%)")) %>%
  add_n() %>%
  as_gt() %>%
  tab_spanner(columns = starts_with("stat_"), md("**Randomization Group**"))
```

---

Modify the function that formats the p-values, and add a correction for multiple testing.
```{r}
trial[!is.na(trial$response), c("response", "age", "grade")] %>%
  tbl_summary(by = response, missing = "no") %>%
  modify_header(stat_1 = md("**No Tumor Response**"), 
                stat_2 = md("**Tumor Responded**")) %>%
  add_p(pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>%
  add_q()
```

---

## Regression Tables

Include number of observations and the number of events in a univariate regresssion table.
```{r}
trial[c("response", "age", "grade")] %>%
  tbl_uvregression(
    method = glm,
    y = response, 
    method.args = list(family = binomial),
    exponentiate = TRUE
  ) %>%
  add_nevent()
```

---

Include two related models side-by-side.
```{r}
gt_r1 <- glm(response ~ trt + age, trial, family = binomial) %>%
  tbl_regression(exponentiate = TRUE)
gt_r2 <- coxph(Surv(ttdeath, death) ~ trt + age, trial) %>%
  tbl_regression(exponentiate = TRUE)

tbl_merge(
  list(gt_r1, gt_r2),
  tab_spanner = c("**Tumor Response**", "**Time to Death**")
)
```

---

Include the number of events at each level of a categorical predictor.
```{r}
gt_model <-
  trial[c("ttdeath", "death", "stage", "grade")] %>%
  tbl_uvregression(
    method = coxph,
    y = Surv(ttdeath, death), 
    exponentiate = TRUE,
    hide_n = TRUE
  )

gt_eventn <-
  trial %>%
  filter(death ==  1) %>%
  select(stage, grade) %>%
  tbl_summary(
    statistic = all_categorical() ~ "{n}",
    label = list(vars(stage) ~ "T Stage", vars(grade) ~ "Grade")
  ) %>%
  modify_header(stat_0 = md("**Event N**"))

tbl_merge(list(gt_eventn, gt_model)) %>%
  as_gt(exclude = "tab_spanner")
```

---

Regression model where the covariates remain the same, and the outcome changes.

```{r}
df_models <-
  tibble(outcome = c("age", "marker")) %>%
  mutate(
    outcome_lbl = map_chr(outcome, ~ attr(trial[[.x]], "label")),
    tbl_reg = map2(
      outcome, outcome_lbl,
      ~ lm(str_glue("{.x} ~ trt"), trial) %>%
        tbl_regression(
          show_single_row = "trt",
          # label = list(trt = str_glue(".y"))
        )
    )
  ) 

df_models %>%
  pull(tbl_reg) %>%
  tbl_stack() %>%
  as_gt() %>%
  tab_footnote(
    footnote = "Values larger than 0 indicate larger values in the Drug group.", 
    locations = cells_column_labels(columns = vars(estimate))
  )
```

Add descriptive statistics by treatment group to the table above for a table often reported for randomized trials.

```{r}
gt_sum <- 
  trial[c("age", "marker", "trt")] %>%
  mutate(trt = fct_rev(trt)) %>%
  tbl_summary(by = trt, 
              statistic = all_continuous() ~ "{mean} ({sd})",
              missing = "no") %>%
  add_n() %>%
  modify_header(stat_by = md("**{level}**"))

tbl_merge(list(
  gt_sum,
  pull(df_models, tbl_reg) %>% tbl_stack()
)) %>%
  modify_header(estimate_2 = md("**Difference**")) %>%
  as_gt(exclude = "tab_spanner")
```
